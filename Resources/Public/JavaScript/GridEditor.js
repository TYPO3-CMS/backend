/*
 * This file is part of the TYPO3 CMS project.
 *
 * It is free software; you can redistribute it and/or modify it under
 * the terms of the GNU General Public License, either version 2
 * of the License, or any later version.
 *
 * For the full copyright and license information, please read the
 * LICENSE.txt file that was distributed with this source code.
 *
 * The TYPO3 project - inspiring people to share!
 */
var __values=this&&this.__values||function(t){var e="function"==typeof Symbol&&t[Symbol.iterator],n=0;return e?e.call(t):{next:function(){return t&&n>=t.length&&(t=void 0),{value:t&&t[n++],done:!t}}}};define(["require","exports","./Enum/Severity","jquery","./Modal","bootstrap"],(function(t,e,n,o,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var a=function(){function t(t){void 0===t&&(t=null);var e=this;this.colCount=1,this.rowCount=1,this.nameLabel="name",this.columnLabel="columen label",this.defaultCell={spanned:0,rowspan:1,colspan:1,name:"",colpos:"",column:void 0},this.selectorEditor=".t3js-grideditor",this.selectorAddColumn=".t3js-grideditor-addcolumn",this.selectorRemoveColumn=".t3js-grideditor-removecolumn",this.selectorAddRowTop=".t3js-grideditor-addrow-top",this.selectorRemoveRowTop=".t3js-grideditor-removerow-top",this.selectorAddRowBottom=".t3js-grideditor-addrow-bottom",this.selectorRemoveRowBottom=".t3js-grideditor-removerow-bottom",this.selectorLinkEditor=".t3js-grideditor-link-editor",this.selectorLinkExpandRight=".t3js-grideditor-link-expand-right",this.selectorLinkShrinkLeft=".t3js-grideditor-link-shrink-left",this.selectorLinkExpandDown=".t3js-grideditor-link-expand-down",this.selectorLinkShrinkUp=".t3js-grideditor-link-shrink-up",this.selectorDocHeaderSave=".t3js-grideditor-savedok",this.selectorDocHeaderSaveClose=".t3js-grideditor-savedokclose",this.selectorConfigPreview=".t3js-grideditor-preview-config",this.selectorConfigPreviewButton=".t3js-grideditor-preview-button",this.modalButtonClickHandler=function(t){var n=t.target;"cancel"===n.name?r.currentModal.trigger("modal-dismiss"):"ok"===n.name&&(e.setName(r.currentModal.find(".t3js-grideditor-field-name").val(),r.currentModal.data("col"),r.currentModal.data("row")),e.setColumn(r.currentModal.find(".t3js-grideditor-field-colpos").val(),r.currentModal.data("col"),r.currentModal.data("row")),e.drawTable(),e.writeConfig(e.export2LayoutRecord()),r.currentModal.trigger("modal-dismiss"))},this.addColumnHandler=function(t){t.preventDefault(),e.addColumn(),e.drawTable(),e.writeConfig(e.export2LayoutRecord())},this.removeColumnHandler=function(t){t.preventDefault(),e.removeColumn(),e.drawTable(),e.writeConfig(e.export2LayoutRecord())},this.addRowTopHandler=function(t){t.preventDefault(),e.addRowTop(),e.drawTable(),e.writeConfig(e.export2LayoutRecord())},this.addRowBottomHandler=function(t){t.preventDefault(),e.addRowBottom(),e.drawTable(),e.writeConfig(e.export2LayoutRecord())},this.removeRowTopHandler=function(t){t.preventDefault(),e.removeRowTop(),e.drawTable(),e.writeConfig(e.export2LayoutRecord())},this.removeRowBottomHandler=function(t){t.preventDefault(),e.removeRowBottom(),e.drawTable(),e.writeConfig(e.export2LayoutRecord())},this.linkEditorHandler=function(t){t.preventDefault();var n=o(t.target);e.showOptions(n.data("col"),n.data("row"))},this.linkExpandRightHandler=function(t){t.preventDefault();var n=o(t.target);e.addColspan(n.data("col"),n.data("row")),e.drawTable(),e.writeConfig(e.export2LayoutRecord())},this.linkShrinkLeftHandler=function(t){t.preventDefault();var n=o(t.target);e.removeColspan(n.data("col"),n.data("row")),e.drawTable(),e.writeConfig(e.export2LayoutRecord())},this.linkExpandDownHandler=function(t){t.preventDefault();var n=o(t.target);e.addRowspan(n.data("col"),n.data("row")),e.drawTable(),e.writeConfig(e.export2LayoutRecord())},this.linkShrinkUpHandler=function(t){t.preventDefault();var n=o(t.target);e.removeRowspan(n.data("col"),n.data("row")),e.drawTable(),e.writeConfig(e.export2LayoutRecord())},this.configPreviewButtonHandler=function(t){t.preventDefault();var n=o(e.selectorConfigPreview),r=o(e.selectorConfigPreviewButton);n.is(":visible")?(r.empty().append(TYPO3.lang["button.showPageTsConfig"]),o(e.selectorConfigPreview).slideUp()):(r.empty().append(TYPO3.lang["button.hidePageTsConfig"]),o(e.selectorConfigPreview).slideDown())};var n=o(this.selectorEditor);this.colCount=n.data("colcount"),this.rowCount=n.data("rowcount"),this.field=o('input[name="'+n.data("field")+'"]'),this.data=n.data("data"),this.nameLabel=null!==t?t.nameLabel:"Name",this.columnLabel=null!==t?t.columnLabel:"Column",this.targetElement=o(this.selectorEditor),o(this.selectorConfigPreview).hide(),o(this.selectorConfigPreviewButton).empty().append(TYPO3.lang["button.showPageTsConfig"]),this.initializeEvents(),this.drawTable(),this.writeConfig(this.export2LayoutRecord())}return t.stripMarkup=function(t){return t=t.replace(/<(.*)>/gi,""),o("<p>"+t+"</p>").text()},t.prototype.initializeEvents=function(){o(document).on("click",this.selectorAddColumn,this.addColumnHandler),o(document).on("click",this.selectorRemoveColumn,this.removeColumnHandler),o(document).on("click",this.selectorAddRowTop,this.addRowTopHandler),o(document).on("click",this.selectorAddRowBottom,this.addRowBottomHandler),o(document).on("click",this.selectorRemoveRowTop,this.removeRowTopHandler),o(document).on("click",this.selectorRemoveRowBottom,this.removeRowBottomHandler),o(document).on("click",this.selectorLinkEditor,this.linkEditorHandler),o(document).on("click",this.selectorLinkExpandRight,this.linkExpandRightHandler),o(document).on("click",this.selectorLinkShrinkLeft,this.linkShrinkLeftHandler),o(document).on("click",this.selectorLinkExpandDown,this.linkExpandDownHandler),o(document).on("click",this.selectorLinkShrinkUp,this.linkShrinkUpHandler),o(document).on("click",this.selectorConfigPreviewButton,this.configPreviewButtonHandler)},t.prototype.getNewCell=function(){return o.extend({},this.defaultCell)},t.prototype.writeConfig=function(t){this.field.val(t);var e,n,r=t.split("\n"),a="";try{for(var i=__values(r),l=i.next();!l.done;l=i.next()){var s=l.value;s&&(a+="\t\t\t"+s+"\n")}}catch(t){e={error:t}}finally{try{l&&!l.done&&(n=i.return)&&n.call(i)}finally{if(e)throw e.error}}o(this.selectorConfigPreview).find("code").empty().append("mod.web_layout.BackendLayouts {\n  exampleKey {\n    title = Example\n    icon = EXT:example_extension/Resources/Public/Images/BackendLayouts/default.gif\n    config {\n"+a.replace(new RegExp("\t","g"),"  ")+"    }\n  }\n}\n")},t.prototype.addRowTop=function(){for(var t=[],e=0;e<this.colCount;e++){var n=this.getNewCell();n.name=e+"x"+this.data.length,t[e]=n}this.data.unshift(t),this.rowCount++},t.prototype.addRowBottom=function(){for(var t=[],e=0;e<this.colCount;e++){var n=this.getNewCell();n.name=e+"x"+this.data.length,t[e]=n}this.data.push(t),this.rowCount++},t.prototype.removeRowTop=function(){if(this.rowCount<=1)return!1;for(var t=[],e=1;e<this.rowCount;e++)t.push(this.data[e]);for(var n=0;n<this.colCount;n++)1===this.data[0][n].spanned&&this.findUpperCellWidthRowspanAndDecreaseByOne(n,0);return this.data=t,this.rowCount--,!0},t.prototype.removeRowBottom=function(){if(this.rowCount<=1)return!1;for(var t=[],e=0;e<this.rowCount-1;e++)t.push(this.data[e]);for(var n=0;n<this.colCount;n++)1===this.data[this.rowCount-1][n].spanned&&this.findUpperCellWidthRowspanAndDecreaseByOne(n,this.rowCount-1);return this.data=t,this.rowCount--,!0},t.prototype.findUpperCellWidthRowspanAndDecreaseByOne=function(t,e){var n=this.getCell(t,e-1);return!!n&&(1===n.spanned?this.findUpperCellWidthRowspanAndDecreaseByOne(t,e-1):n.rowspan>1&&this.removeRowspan(t,e-1),!0)},t.prototype.removeColumn=function(){if(this.colCount<=1)return!1;for(var t=[],e=0;e<this.rowCount;e++){for(var n=[],o=0;o<this.colCount-1;o++)n.push(this.data[e][o]);1===this.data[e][this.colCount-1].spanned&&this.findLeftCellWidthColspanAndDecreaseByOne(this.colCount-1,e),t.push(n)}return this.data=t,this.colCount--,!0},t.prototype.findLeftCellWidthColspanAndDecreaseByOne=function(t,e){var n=this.getCell(t-1,e);return!!n&&(1===n.spanned?this.findLeftCellWidthColspanAndDecreaseByOne(t-1,e):n.colspan>1&&this.removeColspan(t-1,e),!0)},t.prototype.addColumn=function(){for(var t=0;t<this.rowCount;t++){var e=this.getNewCell();e.name=this.colCount+"x"+t,this.data[t].push(e)}this.colCount++},t.prototype.drawTable=function(){for(var e=o("<colgroup>"),n=0;n<this.colCount;n++){var r=100/this.colCount;e.append(o("<col>").css({width:parseInt(r.toString(),10)+"%"}))}var a=o('<table id="base" class="table editor">');a.append(e);for(var i=0;i<this.rowCount;i++){if(0!==this.data[i].length){var l=o("<tr>");for(n=0;n<this.colCount;n++){var s=this.data[i][n];if(1!==s.spanned){var d=100/this.rowCount,c=100/this.colCount,p=o("<td>").css({height:parseInt(d.toString(),10)*s.rowspan+"%",width:parseInt(c.toString(),10)*s.colspan+"%"}),u=o('<div class="cell_container">');p.append(u);var h=o('<a href="#" data-col="'+n+'" data-row="'+i+'">');u.append(h.clone().attr("class","t3js-grideditor-link-editor link link_editor").attr("title",TYPO3.lang.grid_editCell)),this.cellCanSpanRight(n,i)&&u.append(h.clone().attr("class","t3js-grideditor-link-expand-right link link_expand_right").attr("title",TYPO3.lang.grid_mergeCell)),this.cellCanShrinkLeft(n,i)&&u.append(h.clone().attr("class","t3js-grideditor-link-shrink-left link link_shrink_left").attr("title",TYPO3.lang.grid_splitCell)),this.cellCanSpanDown(n,i)&&u.append(h.clone().attr("class","t3js-grideditor-link-expand-down link link_expand_down").attr("title",TYPO3.lang.grid_mergeCell)),this.cellCanShrinkUp(n,i)&&u.append(h.clone().attr("class","t3js-grideditor-link-shrink-up link link_shrink_up").attr("title",TYPO3.lang.grid_splitCell)),p.append(o('<div class="cell_data">').html(TYPO3.lang.grid_name+": "+(s.name?t.stripMarkup(s.name):TYPO3.lang.grid_notSet)+"<br />"+TYPO3.lang.grid_column+": "+(void 0===s.column||isNaN(s.column)?TYPO3.lang.grid_notSet:parseInt(s.column,10)))),s.colspan>1&&p.attr("colspan",s.colspan),s.rowspan>1&&p.attr("rowspan",s.rowspan),l.append(p)}}a.append(l)}}o(this.targetElement).empty().append(a)},t.prototype.setName=function(e,n,o){var r=this.getCell(n,o);return!!r&&(r.name=t.stripMarkup(e),!0)},t.prototype.setColumn=function(t,e,n){var o=this.getCell(e,n);return!!o&&(o.column=parseInt(t.toString(),10),!0)},t.prototype.showOptions=function(e,a){var i,l=this.getCell(e,a);if(!l)return!1;i=0===l.column?0:l.column?parseInt(l.column.toString(),10):"";var s=o("<div>"),d=o('<div class="form-group">'),c=o("<label>"),p=o("<input>");s.append([d.clone().append([c.clone().text(TYPO3.lang.grid_nameHelp),p.clone().attr("type","text").attr("class","t3js-grideditor-field-name form-control").attr("name","name").val(t.stripMarkup(l.name)||"")]),d.clone().append([c.clone().text(TYPO3.lang.grid_columnHelp),p.clone().attr("type","text").attr("class","t3js-grideditor-field-colpos form-control").attr("name","column").val(i)])]);var u=r.show(TYPO3.lang.grid_windowTitle,s,n.SeverityEnum.notice,[{active:!0,btnClass:"btn-default",name:"cancel",text:o(this).data("button-close-text")||TYPO3.lang["button.cancel"]||"Cancel"},{btnClass:"btn-primary",name:"ok",text:o(this).data("button-ok-text")||TYPO3.lang["button.ok"]||"OK"}]);return u.data("col",e),u.data("row",a),u.on("button.clicked",this.modalButtonClickHandler),!0},t.prototype.getCell=function(t,e){return!(t>this.colCount-1)&&(!(e>this.rowCount-1)&&(this.data.length>e-1&&this.data[e].length>t-1?this.data[e][t]:null))},t.prototype.cellCanSpanRight=function(t,e){if(t===this.colCount-1)return!1;var n,o=this.getCell(t,e);if(o.rowspan>1){for(var r=e;r<e+o.rowspan;r++)if(!(n=this.getCell(t+o.colspan,r))||1===n.spanned||n.colspan>1||n.rowspan>1)return!1}else if(!(n=this.getCell(t+o.colspan,e))||1===o.spanned||1===n.spanned||n.colspan>1||n.rowspan>1)return!1;return!0},t.prototype.cellCanSpanDown=function(t,e){if(e===this.rowCount-1)return!1;var n,o=this.getCell(t,e);if(o.colspan>1){for(var r=t;r<t+o.colspan;r++)if(!(n=this.getCell(r,e+o.rowspan))||1===n.spanned||n.colspan>1||n.rowspan>1)return!1}else if(!(n=this.getCell(t,e+o.rowspan))||1===o.spanned||1===n.spanned||n.colspan>1||n.rowspan>1)return!1;return!0},t.prototype.cellCanShrinkLeft=function(t,e){return this.data[e][t].colspan>1},t.prototype.cellCanShrinkUp=function(t,e){return this.data[e][t].rowspan>1},t.prototype.addColspan=function(t,e){var n=this.getCell(t,e);if(!n||!this.cellCanSpanRight(t,e))return!1;for(var o=e;o<e+n.rowspan;o++)this.data[o][t+n.colspan].spanned=1;return n.colspan+=1,!0},t.prototype.addRowspan=function(t,e){var n=this.getCell(t,e);if(!n||!this.cellCanSpanDown(t,e))return!1;for(var o=t;o<t+n.colspan;o++)this.data[e+n.rowspan][o].spanned=1;return n.rowspan+=1,!0},t.prototype.removeColspan=function(t,e){var n=this.getCell(t,e);if(!n||!this.cellCanShrinkLeft(t,e))return!1;n.colspan-=1;for(var o=e;o<e+n.rowspan;o++)this.data[o][t+n.colspan].spanned=0;return!0},t.prototype.removeRowspan=function(t,e){var n=this.getCell(t,e);if(!n||!this.cellCanShrinkUp(t,e))return!1;n.rowspan-=1;for(var o=t;o<t+n.colspan;o++)this.data[e+n.rowspan][o].spanned=0;return!0},t.prototype.export2LayoutRecord=function(){for(var t="backend_layout {\n\tcolCount = "+this.colCount+"\n\trowCount = "+this.rowCount+"\n\trows {\n",e=0;e<this.rowCount;e++){t+="\t\t"+(e+1)+" {\n",t+="\t\t\tcolumns {\n";for(var n=0,o=0;o<this.colCount;o++){var r=this.getCell(o,e);r&&(r.spanned||(t+="\t\t\t\t"+ ++n+" {\n",t+="\t\t\t\t\tname = "+(r.name?r.name:o+"x"+e)+"\n",r.colspan>1&&(t+="\t\t\t\t\tcolspan = "+r.colspan+"\n"),r.rowspan>1&&(t+="\t\t\t\t\trowspan = "+r.rowspan+"\n"),"number"==typeof r.column&&(t+="\t\t\t\t\tcolPos = "+r.column+"\n"),t+="\t\t\t\t}\n"))}t+="\t\t\t}\n",t+="\t\t}\n"}return t+="\t}\n}\n"},t}();e.GridEditor=a}));