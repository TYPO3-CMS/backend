/*
 * This file is part of the TYPO3 CMS project.
 *
 * It is free software; you can redistribute it and/or modify it under
 * the terms of the GNU General Public License, either version 2
 * of the License, or any later version.
 *
 * For the full copyright and license information, please read the
 * LICENSE.txt file that was distributed with this source code.
 *
 * The TYPO3 project - inspiring people to share!
 */
import{ScaffoldIdentifierEnum as b}from"@typo3/backend/enum/viewport/scaffold-identifier.js";import{ModuleSelector as f,ModuleUtility as d,flushModuleCache as I}from"@typo3/backend/module.js";import g from"@typo3/backend/storage/persistent.js";import m from"@typo3/backend/viewport.js";import v from"@typo3/backend/event/client-request.js";import C from"@typo3/backend/event/trigger-request.js";import y from"@typo3/core/ajax/ajax-request.js";import u from"@typo3/core/event/regular-event.js";import{ModuleStateStorage as S}from"@typo3/backend/storage/module-state-storage.js";import{selector as E}from"@typo3/core/literals.js";import k from"@typo3/core/document-service.js";import{Collapse as w}from"bootstrap";import{KeyTypesEnum as a}from"@typo3/backend/enum/key-types.js";var r;(function(h){h.menu="[data-modulemenu]",h.item="[data-modulemenu-identifier]",h.collapsible='[data-modulemenu-collapsible="true"]'})(r||(r={}));class l{constructor(){this.loadedModule=null,k.ready().then(()=>{this.initialize()})}static getModuleMenuItemFromElement(e){return{identifier:e.dataset.modulemenuIdentifier,level:e.parentElement.dataset.modulemenuLevel?parseInt(e.parentElement.dataset.modulemenuLevel,10):null,collapsible:e.dataset.modulemenuCollapsible==="true",expanded:e.attributes.getNamedItem("aria-expanded")?.value==="true",element:e}}static getCollapsedMainMenuItems(){return g.isset("modulemenu")?JSON.parse(g.get("modulemenu")):{}}static addCollapsedMainMenuItem(e){const n=l.getCollapsedMainMenuItems();n[e]=!0,g.set("modulemenu",JSON.stringify(n))}static removeCollapseMainMenuItem(e){const n=this.getCollapsedMainMenuItems();delete n[e],g.set("modulemenu",JSON.stringify(n))}static includeId(e,n){if(!e.navigationComponentId)return n;let t="";e.navigationComponentId==="@typo3/backend/tree/page-tree-element"?t="web":t=e.name.split("_")[0];const o=S.current(t);return o.identifier&&(n="id="+encodeURIComponent(o.identifier)+"&"+n),n}static toggleMenu(e){const n=document.querySelector(b.scaffold),t="scaffold-modulemenu-expanded";typeof e>"u"&&(e=n.classList.contains(t)),n.classList.toggle(t,!e),e||n.classList.remove("scaffold-toolbar-expanded"),g.set("BackendComponents.States.typo3-module-menu",{collapsed:e})}static toggleModuleGroup(e,n){const t=l.getModuleMenuItemFromElement(e),o=t.element.closest(".modulemenu-group"),i=o.querySelector(".modulemenu-group-container"),s=w.getOrCreateInstance(i,{toggle:!1});if(n===void 0)n=!t.expanded;else if(n===t.expanded)return;n?(l.removeCollapseMainMenuItem(t.identifier),s.show()):(l.addCollapsedMainMenuItem(t.identifier),s.hide()),o.classList.toggle("modulemenu-group-collapsed",!n),o.classList.toggle("modulemenu-group-expanded",n),e.setAttribute("aria-expanded",n.toString())}static highlightModule(e){document.querySelector(r.menu).querySelectorAll(r.item).forEach(i=>{i.classList.remove("modulemenu-action-active"),i.removeAttribute("aria-current")}),document.querySelector(".t3js-scaffold-toolbar").querySelectorAll(f.link+".dropdown-item").forEach(i=>{i.classList.remove("active"),i.removeAttribute("aria-current")});const o=d.getFromName(e);this.highlightModuleMenuItem(o,!0)}static highlightModuleMenuItem(e,n=!0){const o=document.querySelector(r.menu).querySelectorAll(r.item+E`[data-modulemenu-identifier="${e.name}"]`);o.forEach(c=>{c.classList.add("modulemenu-action-active"),n&&c.setAttribute("aria-current","location")});const s=document.querySelector(".t3js-scaffold-toolbar").querySelectorAll(f.link+E`[data-moduleroute-identifier="${e.name}"].dropdown-item`);s.forEach(c=>{c.classList.add("active"),n&&c.setAttribute("aria-current","location")}),(o.length>0||s.length>0)&&(n=!1),e.parent!==""&&this.highlightModuleMenuItem(d.getFromName(e.parent),n)}static getPreviousItem(e){const n=e.parentElement.previousElementSibling;return n===null?l.getLastItem(e):n.firstElementChild}static getNextItem(e){const n=e.parentElement.nextElementSibling;return n===null?l.getFirstItem(e):n.firstElementChild}static getFirstItem(e){return e.parentElement.parentElement.firstElementChild.firstElementChild}static getLastItem(e){return e.parentElement.parentElement.lastElementChild.firstElementChild}static getParentItem(e){return e.parentElement.parentElement.parentElement.firstElementChild}static getFirstChildItem(e){const n=e.nextElementSibling;return n&&n.firstElementChild?n.firstElementChild.firstElementChild:null}static hasExpandableChildren(e){return e.nextElementSibling!==null&&e.nextElementSibling.classList.contains("modulemenu-group-container")}refreshMenu(){return new y(TYPO3.settings.ajaxUrls.modulemenu).get().then(async e=>{const n=await e.resolve();document.getElementById("modulemenu").outerHTML=n.menu,I(),this.initializeModuleMenuEvents(),this.loadedModule&&l.highlightModule(this.loadedModule)})}getCurrentModule(){return this.loadedModule}reloadFrames(){m.ContentContainer.refresh()}showModule(e,n,t=null){n=n||"";const o=d.getFromName(e);return this.loadModuleComponents(o,n,new v("typo3.showModule",t))}initialize(){document.querySelector(r.menu)!==null&&(this.initializeModuleMenuEvents(),m.Topbar.Toolbar.registerEvent(()=>{document.querySelector(".t3js-scaffold-toolbar")&&this.initializeTopBarEvents()}))}keyboardNavigation(e,n){const t=l.getModuleMenuItemFromElement(n);let o=null;switch(e.key){case a.UP:o=l.getPreviousItem(t.element);break;case a.DOWN:o=l.getNextItem(t.element);break;case a.LEFT:t.collapsible&&t.expanded?l.toggleModuleGroup(t.element,!1):t.level>1&&(o=l.getParentItem(t.element));break;case a.RIGHT:t.collapsible?t.expanded?o=l.getFirstChildItem(t.element):l.toggleModuleGroup(t.element,!0):t.level===2&&l.hasExpandableChildren(t.element)&&(l.toggleModuleGroup(t.element,!0),o=l.getFirstChildItem(t.element));break;case a.HOME:if(e.ctrlKey&&t.level>1){o=document.querySelector(r.menu+" "+r.item);break}o=l.getFirstItem(t.element);break;case a.END:e.ctrlKey&&t.level>1?o=l.getLastItem(document.querySelector(r.menu+" "+r.item)):o=l.getLastItem(t.element);break;case a.SPACE:case a.ENTER:if(e.preventDefault(),e.repeat)break;t.collapsible?(l.toggleModuleGroup(t.element,!0),o=l.getFirstChildItem(t.element)):t.level===2&&l.hasExpandableChildren(t.element)?l.toggleModuleGroup(t.element):t.element.click();break;case a.ESCAPE:t.level>1?o=l.getParentItem(t.element):t.level===1&&t.collapsible&&(o=t.element),o!==null&&l.toggleModuleGroup(o,!1);break;default:o=null}o!==null&&(e.preventDefault(),o.focus())}initializeModuleMenuEvents(){const e=document.querySelector(r.menu);new u("keydown",this.keyboardNavigation).delegateTo(e,r.item),new u("click",(n,t)=>{if(n.preventDefault(),l.getModuleMenuItemFromElement(t).level===2&&l.hasExpandableChildren(t)){const s=n.target;if(s.classList.contains("modulemenu-indicator")||s.closest(".modulemenu-indicator")){n.stopPropagation(),l.toggleModuleGroup(t);return}}const i=d.getRouteFromElement(t);this.showModule(i.identifier,i.params,n)}).delegateTo(e,f.link),new u("click",(n,t)=>{n.preventDefault(),l.toggleModuleGroup(t)}).delegateTo(e,r.collapsible),new u("shown.bs.collapse",(n,t)=>{t.scrollIntoView({behavior:"smooth",block:"nearest",inline:"start"})}).delegateTo(e,".modulemenu-group")}initializeTopBarEvents(){const e=document.querySelector(".t3js-scaffold-toolbar");new u("click",(t,o)=>{t.preventDefault();const i=d.getRouteFromElement(o);this.showModule(i.identifier,i.params,t)}).delegateTo(e,f.link),new u("click",t=>{t.preventDefault(),l.toggleMenu()}).bindTo(document.querySelector(".t3js-topbar-button-modulemenu")),new u("click",t=>{t.preventDefault(),l.toggleMenu(!0)}).bindTo(document.querySelector(".t3js-scaffold-content-overlay"));const n=t=>{const o=t.detail.module;if(!o||this.loadedModule===o)return;const i=d.getFromName(o);i.link&&(l.highlightModule(o),this.loadedModule=o,i.navigationComponentId?m.NavigationContainer.showComponent(i.navigationComponentId):m.NavigationContainer.hide())};document.addEventListener("typo3-module-load",n),document.addEventListener("typo3-module-loaded",n)}loadModuleComponents(e,n,t){const o=e.name,i=m.ContentContainer.beforeSetUrl(t);return i.then(()=>{e.navigationComponentId?m.NavigationContainer.showComponent(e.navigationComponentId):m.NavigationContainer.hide(),l.highlightModule(o),this.loadedModule=o,n=l.includeId(e,n),this.openInContentContainer(o,e.link,n,new C("typo3.loadModuleComponents",t))}),i}openInContentContainer(e,n,t,o){const i=n+(t?(n.includes("?")?"&":"?")+t:"");return m.ContentContainer.setUrl(i,new C("typo3.openInContentFrame",o),e)}}let p=top?.TYPO3?.ModuleMenu;p||(p={App:new l},top.TYPO3!==void 0&&(top.TYPO3.ModuleMenu=p));var L=p;export{L as default};
