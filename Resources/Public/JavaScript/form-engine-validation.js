/*
 * This file is part of the TYPO3 CMS project.
 *
 * It is free software; you can redistribute it and/or modify it under
 * the terms of the GNU General Public License, either version 2
 * of the License, or any later version.
 *
 * For the full copyright and license information, please read the
 * LICENSE.txt file that was distributed with this source code.
 *
 * The TYPO3 project - inspiring people to share!
 */
import{DateTime as p}from"luxon";import g from"@typo3/backend/hashing/md5.js";import y from"@typo3/backend/modal.js";import v from"@typo3/backend/severity.js";import I from"@typo3/backend/utility.js";import k from"@typo3/core/event/regular-event.js";import w from"@typo3/backend/utility/dom-helper.js";import{selector as d}from"@typo3/core/literals.js";import E from"@typo3/backend/form/submit-interceptor.js";import{FormEngineReview as x}from"@typo3/backend/form-engine-review.js";let o,S=!1;const h=new Map;class r{static{this.rulesSelector="[data-formengine-validation-rules]"}static{this.inputSelector="[data-formengine-input-params]"}static{this.markerSelector=".t3js-formengine-validation-marker"}static{this.labelSelector=".t3js-formengine-label"}static{this.errorClass="has-error"}static{this.validationErrorClass="has-validation-error"}static{this.passwordDummy="********"}static initialize(e){o=e,o.formElement.querySelectorAll("."+r.errorClass).forEach(t=>t.classList.remove(r.errorClass)),r.initializeInputFields(),new x(o.formElement),new k("change",(t,s)=>{r.validateField(s),o.markFieldAsChanged(s)}).delegateTo(o.formElement,r.rulesSelector),r.registerSubmitCallback(),r.validate()}static initializeInputFields(){o.formElement.querySelectorAll(r.inputSelector).forEach(e=>{if("formengineInputInitialized"in e.dataset)return;const s=JSON.parse(e.dataset.formengineInputParams).field,a=o.formElement.querySelector(d`[name="${s}"]`);a.dataset.config=e.dataset.formengineInputParams,r.initializeInputField(s)})}static initializeInputField(e){const t=o.formElement.querySelector(d`[name="${e}"]`),s=o.formElement.querySelector(d`[data-formengine-input-name="${e}"]`);if(t.dataset.config!==void 0){const a=JSON.parse(t.dataset.config),i=r.formatByEvals(a,t.value);i.length&&(s.value=i)}new k("change",()=>{r.updateInputField(s.dataset.formengineInputName)}).bindTo(s),s.dataset.formengineInputInitialized="true"}static registerCustomEvaluation(e,t){h.has(e)||h.set(e,t)}static formatByEvals(e,t){if(e.evalList!==void 0){const s=I.trimExplode(",",e.evalList);for(const a of s)t=r.formatValue(a,t)}return t}static formatValue(e,t){switch(e){case"date":case"datetime":case"time":case"timesec":if(t==="")return"";const s=p.fromISO(String(t));if(!s.isValid)throw new Error("Invalid ISO8601 DateTime string: "+t);return s.toISO({suppressMilliseconds:!0,includeOffset:!1});case"password":return t?r.passwordDummy:"";default:return t.toString()}}static updateInputField(e){const t=o.formElement.querySelector(d`[name="${e}"]`),s=o.formElement.querySelector(d`[data-formengine-input-name="${e}"]`);if(t.dataset.config!==void 0){const a=JSON.parse(t.dataset.config),i=r.processByEvals(a,s.value),u=r.formatByEvals(a,i);t.value!==i&&(t.disabled&&t.dataset.enableOnModification&&(t.disabled=!1),t.value=i,t.dispatchEvent(new Event("change"))),s.value!==u&&(s.value=u)}}static validateField(e){if(e.dataset.formengineValidationRules===void 0)return;let t=e.value||"";const s=JSON.parse(e.dataset.formengineValidationRules);let a=!1,i=0,u,n,c;Array.isArray(t)||(t=t.trimStart());for(const l of s){if(a)break;switch(l.type){case"required":t===""&&(a=!0,e.classList.add(r.errorClass),e.closest(r.markerSelector)?.querySelector(r.labelSelector)?.classList.add(r.errorClass));break;case"range":if(t!==""){if((l.minItems||l.maxItems)&&(u=o.formElement.querySelector(d`[name="${e.dataset.relatedfieldname}"]`),u!==null?i=I.trimExplode(",",u.value).length:i=parseInt(e.value,10),l.minItems!==void 0&&(n=l.minItems*1,!isNaN(n)&&i<n&&(a=!0)),l.maxItems!==void 0&&(c=l.maxItems*1,!isNaN(c)&&i>c&&(a=!0))),l.lower!==void 0)if(e.dataset.inputType==="datetimepicker"){const m=p.fromISO(t,{zone:"utc"}),b=p.fromISO(l.lower,{zone:"utc"});(!m.isValid||m<b.minus(b.second*1e3))&&(a=!0)}else{const m=l.lower*1;!isNaN(m)&&parseInt(t,10)<m&&(a=!0)}if(l.upper!==void 0)if(e.dataset.inputType==="datetimepicker"){const m=p.fromISO(t,{zone:"utc"}),b=p.fromISO(l.upper,{zone:"utc"});(!m.isValid||m>b.plus((59-b.second)*1e3))&&(a=!0)}else{const m=l.upper*1;!isNaN(m)&&parseInt(t,10)>m&&(a=!0)}}break;case"select":case"category":(l.minItems||l.maxItems)&&(u=o.formElement.querySelector(d`[name="${e.dataset.relatedfieldname}"]`),u!==null?i=I.trimExplode(",",u.value).length:e instanceof HTMLSelectElement?i=e.querySelectorAll("option:checked").length:i=e.querySelectorAll("input[value]:checked").length,l.minItems!==void 0&&(n=l.minItems*1,!isNaN(n)&&i<n&&(a=!0)),l.maxItems!==void 0&&(c=l.maxItems*1,!isNaN(c)&&i>c&&(a=!0)));break;case"group":case"folder":(l.minItems||l.maxItems)&&(i=I.trimExplode(",",e.value).length,l.minItems!==void 0&&(n=l.minItems*1,!isNaN(n)&&i<n&&(a=!0)),l.maxItems!==void 0&&(c=l.maxItems*1,!isNaN(c)&&i>c&&(a=!0)));break;case"inline":(l.minItems||l.maxItems)&&(i=I.trimExplode(",",e.value).length,l.minItems!==void 0&&(n=l.minItems*1,!isNaN(n)&&i<n&&(a=!0)),l.maxItems!==void 0&&(c=l.maxItems*1,!isNaN(c)&&i>c&&(a=!0)));break;case"min":(e instanceof HTMLInputElement||e instanceof HTMLTextAreaElement)&&e.value.length>0&&e.value.length<e.minLength&&(a=!0);break;case"null":break;default:break}}const f=!a;e.classList.toggle(r.errorClass,!f),e.setAttribute("aria-invalid",a.toString()),e.closest(r.markerSelector)?.querySelector(r.labelSelector)?.classList.toggle(r.errorClass,!f),r.markParentTab(e,f),o.formElement.dispatchEvent(new CustomEvent("t3-formengine-postfieldvalidation",{detail:{field:e,isValid:f},cancelable:!1,bubbles:!0}))}static processByEvals(e,t){if(e.evalList!==void 0){const s=I.trimExplode(",",e.evalList);for(const a of s)t=r.processValue(a,t,e)}return t}static processValue(e,t,s){let a="",i="",u=0,n=t;switch(e){case"alpha":case"num":case"alphanum":case"alphanum_x":for(a="",u=0;u<t.length;u++){const c=t.substr(u,1);let f=c==="_"||c==="-",l=c>="a"&&c<="z"||c>="A"&&c<="Z",m=c>="0"&&c<="9";switch(e){case"alphanum":f=!1;break;case"alpha":m=!1,f=!1;break;case"num":l=!1,f=!1;break;default:break}(l||m||f)&&(a+=c)}a!==t&&(n=a);break;case"is_in":if(s.is_in){i=""+t,s.is_in=s.is_in.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&");const c=new RegExp("[^"+s.is_in+"]+","g");a=i.replace(c,"")}else a=i;n=a;break;case"nospace":n=(""+t).replace(/ /g,"");break;case"md5":t!==""&&(n=g.hash(t));break;case"upper":n=t.toUpperCase();break;case"lower":n=t.toLowerCase();break;case"integer":t!==""&&(n=r.parseInt(t).toString());break;case"decimal":t!==""&&(n=r.parseDouble(t));break;case"trim":n=String(t).trim();break;case"time":case"timesec":t!==""&&(n=p.fromISO(t).set({year:1970,month:1,day:1}).toISO({suppressMilliseconds:!0,includeOffset:!1}));break;case"null":break;case"password":break;default:h.has(e)?n=h.get(e).call(null,t):typeof TBE_EDITOR=="object"&&TBE_EDITOR.customEvalFunctions!==void 0&&typeof TBE_EDITOR.customEvalFunctions[e]=="function"&&(n=TBE_EDITOR.customEvalFunctions[e](t))}return n}static validate(e){(typeof e>"u"||e instanceof Document)&&o.formElement.querySelectorAll(r.markerSelector+", .t3js-tabmenu-item").forEach(s=>{s.classList.remove(r.validationErrorClass)});const t=e||document;for(const s of t.querySelectorAll(r.rulesSelector))s.closest(".t3js-flex-section-deleted, .t3js-inline-record-deleted, .t3js-file-reference-deleted")===null&&r.validateField(s)}static markFieldAsChanged(e){console.warn("Calling markFieldAsChanged() from '@typo3/backend/form-engine-validation' is deprecated and will be removed in TYPO3 v15. Instead, call the method from '@typo3/backend/form-engine'."),o.markFieldAsChanged(e)}static parseInt(e){const t=""+e;if(!e)return 0;const s=parseInt(t,10);return isNaN(s)?0:s}static parseDouble(e,t=2){let s=""+e;s=s.replace(/[^0-9,.-]/g,"");const a=s.startsWith("-");s=s.replace(/-/g,""),s=s.replace(/,/g,"."),s.indexOf(".")===-1&&(s+=".0");const i=s.split("."),u=i.pop();let n=+(i.join("")+"."+u);return a&&(n*=-1),s=n.toFixed(t),s}static markParentTab(e,t){w.parents(e,".tab-pane").forEach(a=>{t&&(t=a.querySelector(".has-error")===null);const i=a.id;o.formElement.querySelector('[data-bs-target="#'+i+'"]').closest(".t3js-tabmenu-item").classList.toggle(r.validationErrorClass,!t)})}static suspend(){S=!0}static resume(){S=!1}static isValid(){return document.querySelector("."+r.errorClass)===null}static showErrorModal(){const e=y.confirm(TYPO3.lang.alert||"Alert",TYPO3.lang["FormEngine.fieldsMissing"],v.error,[{text:TYPO3.lang["button.ok"]||"OK",active:!0,btnClass:"btn-default",name:"ok"}]);e.addEventListener("button.clicked",()=>e.hideModal())}static registerSubmitCallback(){new E(o.formElement).addPreSubmitCallback(()=>S||r.isValid()?!0:(r.showErrorModal(),!1))}}export{r as default};
