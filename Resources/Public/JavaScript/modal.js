/*
 * This file is part of the TYPO3 CMS project.
 *
 * It is free software; you can redistribute it and/or modify it under
 * the terms of the GNU General Public License, either version 2
 * of the License, or any later version.
 *
 * For the full copyright and license information, please read the
 * LICENSE.txt file that was distributed with this source code.
 *
 * The TYPO3 project - inspiring people to share!
 */
import{LitElement as A,html as r,nothing as B}from"lit";import{property as c,state as O,query as S,customElement as Y}from"lit/decorators.js";import{unsafeHTML as q}from"lit/directives/unsafe-html.js";import{classMap as D}from"lit/directives/class-map.js";import{ifDefined as x}from"lit/directives/if-defined.js";import{classesArrayToClassInfo as g}from"@typo3/core/lit-helper.js";import E from"@typo3/core/event/regular-event.js";import{SeverityEnum as y}from"@typo3/backend/enum/severity.js";import I from"@typo3/core/ajax/ajax-request.js";import z from"@typo3/backend/severity.js";import"@typo3/backend/element/icon-element.js";import"@typo3/backend/element/spinner-element.js";import N from"~labels/core.core";import j from"~labels/core.mod_web_list";var n=function(o,t,e,s){var a=arguments.length,l=a<3?t:s===null?s=Object.getOwnPropertyDescriptor(t,e):s,h;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")l=Reflect.decorate(o,t,e,s);else for(var f=o.length-1;f>=0;f--)(h=o[f])&&(l=(a<3?h(l):a>3?h(t,e,l):h(t,e))||l);return a>3&&l&&Object.defineProperty(t,e,l),l},$;(function(o){o.modal=".t3js-modal",o.header=".t3js-modal-header",o.close=".t3js-modal-close",o.body=".t3js-modal-body",o.footer=".t3js-modal-footer"})($||($={}));var p;(function(o){o.small="small",o.default="default",o.medium="medium",o.large="large",o.full="full"})(p||(p={}));var u;(function(o){o.center="center",o.top="top",o.end="end",o.bottom="bottom",o.start="start"})(u||(u={}));var C;(function(o){o.default="default",o.light="light",o.dark="dark"})(C||(C={}));var d;(function(o){o.default="default",o.template="template",o.ajax="ajax",o.iframe="iframe"})(d||(d={}));let F=0,i=class extends A{constructor(){super(),this.modalTitle="",this.content="",this.type=d.default,this.severity=y.notice,this.variant=C.default,this.size=p.default,this.position=u.center,this.staticBackdrop=!1,this.hideCloseButton=!1,this.hideHeader=!1,this.additionalCssClasses=[],this.buttons=[],this.templateResultContent=null,this.activeButton=null,this.callback=null,this.ajaxCallback=null,this.userData={},this.handleIframeKeydown=t=>{if(t.key==="Escape"){if(t.target instanceof t.view.window.HTMLInputElement&&t.target.type==="search"){t.target.value===""&&this.requestClose();return}if(t.defaultPrevented)return;this.requestClose()}},this.uniqueId=++F}setContent(t){this.templateResultContent=t}hideModal(){this.doHideModal()}async doHideModal(){this.trigger("typo3-modal-hide"),this.dialog.classList.add("modal-closing");const t=new Promise(s=>this.dialog.addEventListener("transitionend",s,{once:!0})),e=new Promise(s=>setTimeout(s,305));await Promise.race([t,e]),this.dialog.classList.remove("modal-closing"),this.dialog.close()}createRenderRoot(){return this}async showModal(){await new Promise(s=>requestAnimationFrame(s)),this.trigger("typo3-modal-show"),this.dialog.showModal();const t=new Promise(s=>this.dialog.addEventListener("transitionend",s,{once:!0})),e=new Promise(s=>setTimeout(s,305));await Promise.race([t,e]),this.trigger("typo3-modal-shown")}firstUpdated(){this.showModal(),this.callback&&this.callback(this)}updated(t){t.has("templateResultContent")&&this.dispatchEvent(new CustomEvent("modal-updated",{bubbles:!0}))}render(){const t=g(["modal","t3js-modal",`modal-type-${this.type}`,`modal-style-${this.variant}`,`modal-severity-${z.getCssClass(this.severity)}`,`modal-size-${this.size}`,`modal-position-${this.position}`,...this.additionalCssClasses]);return r`<dialog class=${D(t)} aria-labelledby=${x(this.hideHeader?void 0:`t3-modal-header-${this.uniqueId}`)} aria-label=${x(this.hideHeader?this.modalTitle:void 0)} closedby=${this.hideCloseButton?"none":"closerequest"} @close=${this.handleDialogClose} @cancel=${this.handleDialogCancel} @click=${this.handleDialogClick}>${this.hideHeader?B:r`<div class="modal-header t3js-modal-header"><div class="modal-header-title t3js-modal-title" id=t3-modal-header-${this.uniqueId}>${this.modalTitle}</div>${this.hideCloseButton?B:r`<button class="modal-header-close t3js-modal-close" @click=${()=>this.hideModal()}><typo3-backend-icon identifier=actions-close size=small></typo3-backend-icon><span class=visually-hidden>${j.get("button.close")+" "+this.modalTitle}</span></button>`}</div>`}<div class="modal-body t3js-modal-body">${this.renderModalBody()}</div>${this.buttons.length===0?B:r`<div class="modal-footer t3js-modal-footer">${this.buttons.map(e=>this.renderModalButton(e))}</div>`}</dialog>`}handleDialogClose(){this.trigger("typo3-modal-hidden")}handleDialogCancel(t){this.hideCloseButton&&t.preventDefault(),t.defaultPrevented?this.shake():(t.preventDefault(),this.hideModal())}handleDialogClick(t){t.target===this.dialog&&(this.staticBackdrop?this.shake():this.requestClose())}_buttonClick(t,e){const s=t.currentTarget;e.action?(this.activeButton=e,e.action.execute(s).then(()=>this.hideModal())):e.trigger&&e.trigger(t,this),s.dispatchEvent(new CustomEvent("button.clicked",{bubbles:!0}))}renderAjaxBody(){return this.templateResultContent===null?(new I(this.content).get().then(async t=>{const e=await t.raw().text();this.templateResultContent=r`${q(e)}`,this.updateComplete.then(()=>{this.ajaxCallback&&this.ajaxCallback(this),this.dispatchEvent(new CustomEvent("modal-loaded"))})}).catch(async t=>{const e=await t.raw().text();e?this.templateResultContent=r`${q(e)}`:this.templateResultContent=r`<p><strong>Oops, received a ${t.response.status} response from </strong><span class=text-break>${this.content}</span>.</p>`}),r`<div class=modal-loading><typo3-backend-spinner size=large></typo3-backend-spinner></div>`):this.templateResultContent}renderModalBody(){if(this.type===d.iframe){const t=e=>{const s=e.currentTarget;s.contentDocument.title&&(this.modalTitle=s.contentDocument.title),s.contentDocument.addEventListener("keydown",this.handleIframeKeydown)};return r`<iframe src=${this.content} name=modal_frame class="modal-iframe t3js-modal-iframe" @load=${t}></iframe>`}return this.type===d.ajax?this.renderAjaxBody():this.type===d.template?this.templateResultContent:r`<p>${this.content}</p>`}renderModalButton(t){const s={btn:!0,[t.btnClass||"btn-default"]:!0,"t3js-active":t.active,disabled:this.activeButton&&this.activeButton!==t};return r`<button class=${D(s)} name=${x(t.name||void 0)} form=${x(t.form||void 0)} @click=${a=>this._buttonClick(a,t)}>${t.icon?r`<typo3-backend-icon identifier=${t.icon} size=small></typo3-backend-icon>`:B} ${t.text}</button>`}trigger(t){this.dispatchEvent(new CustomEvent(t,{bubbles:!0,composed:!0}))}requestClose(){"requestClose"in this.dialog?this.dialog.requestClose():this.hideCloseButton?this.hideModal():this.shake()}shake(){window.matchMedia("(prefers-reduced-motion: reduce)").matches||this.dialog.animate([{transform:"translateX(0px)"},{transform:"translateX(-2px)"},{transform:"translateX(0px)"},{transform:"translateX(2px)"},{transform:"translateX(0px)"}],150)}};n([c({type:String,reflect:!0})],i.prototype,"modalTitle",void 0),n([c({type:String,reflect:!0})],i.prototype,"content",void 0),n([c({type:String,reflect:!0})],i.prototype,"type",void 0),n([c({type:String,reflect:!0})],i.prototype,"severity",void 0),n([c({type:String,reflect:!0})],i.prototype,"variant",void 0),n([c({type:String,reflect:!0})],i.prototype,"size",void 0),n([c({type:String,reflect:!0})],i.prototype,"position",void 0),n([c({type:Boolean})],i.prototype,"staticBackdrop",void 0),n([c({type:Boolean})],i.prototype,"hideCloseButton",void 0),n([c({type:Boolean})],i.prototype,"hideHeader",void 0),n([c({type:Array})],i.prototype,"additionalCssClasses",void 0),n([c({type:Array,attribute:!1})],i.prototype,"buttons",void 0),n([O()],i.prototype,"templateResultContent",void 0),n([O()],i.prototype,"activeButton",void 0),n([S("dialog",!0)],i.prototype,"dialog",void 0),i=n([Y("typo3-backend-modal")],i);class T{constructor(){this.sizes=p,this.styles=C,this.types=d,this.positions=u,this.currentModal=null,this.instances=[],this.defaultConfiguration={type:d.default,title:"Information",content:"No content provided, please check your <code>Modal</code> configuration.",severity:y.notice,buttons:[],style:C.default,size:p.default,position:u.center,additionalCssClasses:[],callback:null,ajaxCallback:null,staticBackdrop:!1,hideCloseButton:!1,hideHeader:!1},this.initializeMarkupTrigger(document)}static createModalResponseEventFromElement(t,e){return t.dataset.eventName?new CustomEvent(t.dataset.eventName,{bubbles:!0,detail:{result:e,payload:t.dataset.eventPayload||null}}):null}dismiss(){this.currentModal&&this.currentModal.hideModal()}confirm(t,e,s=y.warning,a=[],l){a.length===0&&a.push({text:j.get("button.cancel"),active:!0,btnClass:"btn-default",name:"cancel"},{text:j.get("button.ok"),btnClass:"btn-"+z.getCssClass(s),name:"ok"});const h=this.advanced({title:t,content:e,severity:s,buttons:a,additionalCssClasses:l});return h.addEventListener("button.clicked",f=>{const v=f.target;v.getAttribute("name")==="cancel"?v.dispatchEvent(new CustomEvent("confirm.button.cancel",{bubbles:!0})):v.getAttribute("name")==="ok"&&v.dispatchEvent(new CustomEvent("confirm.button.ok",{bubbles:!0}))}),h}loadUrl(t,e=y.info,s,a,l){return this.advanced({type:d.ajax,title:t,severity:e,buttons:s,ajaxCallback:l,content:a})}show(t,e,s=y.info,a,l){return this.advanced({type:d.default,title:t,content:e,severity:s,buttons:a,additionalCssClasses:l})}advanced(t){return t.type=typeof t.type=="string"&&t.type in d?t.type:this.defaultConfiguration.type,t.title=typeof t.title=="string"?t.title:this.defaultConfiguration.title,t.content=typeof t.content=="string"||typeof t.content=="object"?t.content:this.defaultConfiguration.content,t.severity=typeof t.severity<"u"?t.severity:this.defaultConfiguration.severity,t.buttons=t.buttons||this.defaultConfiguration.buttons,t.size=typeof t.size=="string"&&t.size in p?t.size:this.defaultConfiguration.size,t.style=typeof t.style=="string"&&t.style in C?t.style:this.defaultConfiguration.style,t.position=typeof t.position=="string"&&t.position in u?t.position:this.defaultConfiguration.position,t.additionalCssClasses=t.additionalCssClasses||this.defaultConfiguration.additionalCssClasses,t.callback=typeof t.callback=="function"?t.callback:this.defaultConfiguration.callback,t.ajaxCallback=typeof t.ajaxCallback=="function"?t.ajaxCallback:this.defaultConfiguration.ajaxCallback,t.hideCloseButton=t.hideCloseButton||this.defaultConfiguration.hideCloseButton,t.staticBackdrop=t.staticBackdrop||this.defaultConfiguration.staticBackdrop,t.hideHeader=t.hideHeader||this.defaultConfiguration.hideHeader,this.generate(t)}setButtons(t){return this.currentModal.buttons=t,this.currentModal}initializeMarkupTrigger(t){const e=(s,a)=>{s.preventDefault(),"bsContent"in a.dataset&&!("content"in a.dataset)&&console.error("TYPO3 v14 modal trigger dropped support for the legacy `data-bs-content` attribute. Use `data-content` instead. Affected element:",a);const l=a.dataset.content||N.get("message.confirmation");let h=y.notice;if(a.dataset.severity in y){const m=a.dataset.severity;h=y[m]}let f=p.default;if(a.dataset.size in p){const m=a.dataset.size;f=p[m]}let v=u.center;if(a.dataset.position in u){const m=a.dataset.position;v=u[m]}const H=a.dataset.hideHeader!==void 0,L=a.dataset.staticBackdrop!==void 0;let b=a.dataset.url||null;if(b!==null){const m=b.includes("?")?"&":"?",w=new URLSearchParams(a.dataset).toString();b=b+m+w}this.advanced({type:b!==null?d.ajax:d.default,title:a.dataset.title||"Alert",content:b!==null?b:l,size:f,severity:h,position:v,hideHeader:H,staticBackdrop:L,buttons:[{text:a.dataset.buttonCloseText||j.get("button.close"),active:!0,btnClass:"btn-default",trigger:(m,w)=>{w.hideModal();const M=T.createModalResponseEventFromElement(a,!1);M!==null&&a.dispatchEvent(M)}},{text:a.dataset.buttonOkText||j.get("button.ok"),btnClass:"btn-"+z.getCssClass(h),trigger:(m,w)=>{w.hideModal();const M=T.createModalResponseEventFromElement(a,!0);M!==null&&a.dispatchEvent(M);const R=a.dataset.uri||a.dataset.href||a.getAttribute("href");if(R&&R!=="#"&&(a.ownerDocument.location.href=R),a.getAttribute("type")==="submit"&&(a.tagName==="BUTTON"||a.tagName==="INPUT")){const P=a;P.form?.requestSubmit(P)}a.dataset.targetForm&&a.ownerDocument.querySelector("form#"+a.dataset.targetForm)?.submit()}}]})};new E("click",e).delegateTo(t,".t3js-modal-trigger")}generate(t){const e=document.createElement("typo3-backend-modal");return e.type=t.type,typeof t.content=="string"?e.content=t.content:t.type===d.default&&(e.type=d.template,e.templateResultContent=t.content),e.severity=t.severity,e.variant=t.style,e.size=t.size,e.position=t.position,e.modalTitle=t.title,e.additionalCssClasses=t.additionalCssClasses,e.buttons=t.buttons,e.hideCloseButton=t.hideCloseButton,e.staticBackdrop=t.staticBackdrop,e.hideHeader=t.hideHeader,t.callback&&(e.callback=t.callback),t.ajaxCallback&&(e.ajaxCallback=t.ajaxCallback),e.addEventListener("typo3-modal-shown",()=>{const s=e.querySelector(`${$.footer} .t3js-active`);s!==null&&s.focus()}),e.addEventListener("typo3-modal-hide",()=>{if(this.instances.length>0){const s=this.instances.length-1;this.instances.splice(s,1),this.currentModal=this.instances[s-1]}}),e.addEventListener("typo3-modal-hidden",()=>{e.remove()}),e.addEventListener("typo3-modal-show",()=>{this.currentModal=e,this.instances.push(e)}),document.body.appendChild(e),e}}let k=null;try{parent&&parent.window.TYPO3&&parent.window.TYPO3.Modal?(parent.window.TYPO3.Modal.initializeMarkupTrigger(document),k=parent.window.TYPO3.Modal):top&&top.TYPO3.Modal&&(top.TYPO3.Modal.initializeMarkupTrigger(document),k=top.TYPO3.Modal)}catch{}k||(k=new T,typeof TYPO3<"u"&&(TYPO3.Modal=k));var U=k;export{$ as Identifiers,i as ModalElement,u as Positions,p as Sizes,C as Styles,d as Types,U as default};
