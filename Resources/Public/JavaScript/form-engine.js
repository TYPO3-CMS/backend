/*
 * This file is part of the TYPO3 CMS project.
 *
 * It is free software; you can redistribute it and/or modify it under
 * the terms of the GNU General Public License, either version 2
 * of the License, or any later version.
 *
 * For the full copyright and license information, please read the
 * LICENSE.txt file that was distributed with this source code.
 *
 * The TYPO3 project - inspiring people to share!
 */
import P from"@typo3/core/document-service.js";import c from"jquery";import j from"@typo3/backend/form-engine-validation.js";import f from"@typo3/backend/modal.js";import*as O from"@typo3/backend/utility/message-utility.js";import w from"@typo3/backend/severity.js";import*as V from"@typo3/backend/backend-exception.js";import H from"@typo3/backend/event/interaction-request-map.js";import D from"@typo3/backend/utility.js";import{selector as g}from"@typo3/core/literals.js";import"@typo3/backend/form-engine/element/extra/char-counter.js";import M,{ModifierKeys as B}from"@typo3/backend/hotkeys.js";import v from"@typo3/core/event/regular-event.js";import l from"~labels/backend.alt_doc";import L from"~labels/core.core";var b;(function(y){y.save="_savedok",y.saveAndClose="_saveandclosedok",y.saveAndView="_savedokview",y.saveAndNew="_savedoknew",y.duplicate="_duplicatedoc"})(b||(b={}));var R=function(){function y(t,n){n?e.interactionRequestMap.resolveFor(t):e.interactionRequestMap.rejectFor(t)}const k=new Map;k.set("typo3-backend-form-update-value",t=>{const n=document.querySelector(g`[name="${t.elementName}"]`),a=document.querySelector(g`[data-formengine-input-name="${t.elementName}"]`);e.Validation.updateInputField(t.elementName),n!==null&&(e.markFieldAsChanged(n),e.Validation.validateField(n)),a!==null&&a!==n&&e.Validation.validateField(a)}),k.set("typo3-backend-form-reload",t=>{const n=()=>{e.Validation.suspend(),e.saveDocument(),e.Validation.resume()};if(!t.confirmation){n();return}const a=f.advanced({title:L.get("mess.refreshRequired.title"),content:L.get("mess.refreshRequired.content"),severity:w.warning,staticBackdrop:!0,buttons:[{text:L.get("mess.refreshRequired.cancel"),active:!0,btnClass:"btn-default",name:"cancel",trigger:()=>{a.hideModal()}},{text:L.get("mess.refreshRequired.confirm"),btnClass:"btn-"+w.getCssClass(w.warning),name:"ok",trigger:()=>{e.disableDocHeaderButtons(),e.closeModalsRecursive(),n()}}]})}),k.set("typo3-backend-form-update-bitmask",(t,n)=>{const a=n.target,o=e.formElement[t.elementName],i=a.checked!==t.invert,r=Math.pow(2,t.position),d=Math.pow(2,t.total)-r-1;o.value=i?o.value|r:o.value&d,o.dispatchEvent(new Event("change",{bubbles:!0,cancelable:!0}))});let x=!1,F=null;const e={consumeTypes:["typo3.setUrl","typo3.beforeSetUrl","typo3.refresh"],Validation:j,interactionRequestMap:H,formName:TYPO3.settings.FormEngine.formName,formElement:void 0,openedPopupWindow:null,browserUrl:""};Object.defineProperty(e,"formElement",{get:()=>document.forms.namedItem(e.formName),enumerable:!0,configurable:!1}),e.ready=async function(){return F??(F=async function(){x||await new Promise(n=>e.formElement.addEventListener("typo3:form-engine:ready",()=>n(),{once:!0}))}())},e.openPopupWindow=function(t,n,a){const o={mode:t,bparams:n};return a&&(t==="db"?o.expandPage=a:o.expandFolder=a),f.advanced({type:f.types.iframe,content:e.browserUrl+"&"+new URLSearchParams(o).toString(),size:f.sizes.large})},e.setSelectOptionFromExternalSource=function(t,n,a,o,i=[],r=void 0){let d,s,u=!1,h=!1;s=e.getFieldElement(t),d=s.get(0);const m=s.get(0);if(m===null||n==="--div--"||m instanceof HTMLOptGroupElement)return;const _=e.getFieldElement(t,"_list",!0);if(_.length>0&&(s=_,d=s.get(0),u=s.prop("multiple")&&s.prop("size")!="1",h=!0),u||h){const E=e.getFieldElement(t,"_avail"),S=E.get(0);if(!u){for(const p of d.querySelectorAll("option")){const C=E.find(g`option[value="${c(p).attr("value")}"]`);C.length&&(C.removeClass("hidden").prop("disabled",!1),e.enableOptGroup(C.get(0)))}s.empty()}if(i.length>0){let p=!1;(i.includes(n)||s.find("option").length==1&&i.includes(s.find("option").prop("value")))&&(s.empty(),p=!0),p&&typeof r<"u"&&r.closest("select").querySelectorAll("[disabled]").forEach(function(C){C.classList.remove("hidden"),C.disabled=!1,e.enableOptGroup(C)})}let A=!0;const q=e.getFieldElement(t,"_mul",!0);if(q.length==0||q.val()==0){for(const p of d.querySelectorAll("option"))if(p.value==n){A=!1;break}if(A&&typeof r<"u"){r.classList.add("hidden"),r.disabled=!0;const p=r.parentElement;p instanceof HTMLOptGroupElement&&p.querySelectorAll("option:not([disabled]):not([hidden]):not(.hidden)").length===0&&(p.disabled=!0,p.classList.add("hidden"))}}if(A){const p=c("<option></option>");p.attr({value:n,title:o}).text(a),p.appendTo(s),e.updateHiddenFieldValueFromSelect(d,m),e.markFieldAsChanged(m),e.Validation.validateField(d),e.Validation.validateField(S)}}else{const E=/_(\d+)$/,S=n.toString().match(E);S!=null&&(n=S[1]),s.val(n),e.Validation.validateField(d)}},e.updateHiddenFieldValueFromSelect=function(t,n){const a=Array.from(t.options).map(o=>o.value);n.value=a.join(","),n.dispatchEvent(new Event("change",{bubbles:!0,cancelable:!0}))},e.getFieldElement=function(t,n,a){if(n){let o;switch(n){case"_list":o=c(g`:input[data-formengine-input-name="${t}"]:not([type=hidden])`,e.formElement);break;case"_avail":o=c(g`:input[data-relatedfieldname="${t}"]`,e.formElement);break;case"_mul":o=c(g`:input[type=hidden][data-formengine-input-name="${t}"]`,e.formElement);break;default:o=null;break}if(o&&o.length>0||a===!0)return o}return c(e.formElement.elements.namedItem(t))},e.initializeEvents=function(){top.TYPO3&&typeof top.TYPO3.Backend<"u"&&(top.TYPO3.Backend.consumerScope.attach(e),window.addEventListener("pagehide",()=>top.TYPO3.Backend.consumerScope.detach(e),{once:!0})),new v("click",t=>{t.preventDefault(),e.preventExitIfNotSaved(e.preventExitIfNotSavedCallback)}).delegateTo(document,".t3js-editform-close"),new v("click",t=>{t.preventDefault(),e.previewAction(t,e.previewActionCallback)}).delegateTo(document,".t3js-editform-view"),new v("click",t=>{t.preventDefault(),e.newAction(t,e.newActionCallback)}).delegateTo(document,".t3js-editform-new"),new v("click",t=>{t.preventDefault(),e.duplicateAction(t,e.duplicateActionCallback)}).delegateTo(document,".t3js-editform-duplicate"),new v("click",t=>{t.preventDefault(),e.deleteAction(t,e.deleteActionCallback)}).delegateTo(document,".t3js-editform-delete-record"),new v("change",(t,n)=>{n.closest(".t3js-formengine-field-item").classList.toggle("disabled")}).delegateTo(document,'.t3-form-field-eval-null-checkbox input[type="checkbox"]'),new v("change",(t,n)=>{e.toggleCheckboxField(n),e.markFieldAsChanged(n)}).delegateTo(document,'.t3js-form-field-eval-null-placeholder-checkbox input[type="checkbox"]'),new v("click",(t,n)=>{t.preventDefault(),t.stopPropagation();const a=n.dataset.mode,o=n.dataset.params,i=n.dataset.entryPoint;e.openPopupWindow(a,o,i)}).delegateTo(document,".t3js-element-browser"),new v("click",(t,n)=>{const a=JSON.parse(n.dataset.formengineFieldChangeItems);e.processOnFieldChange(a,t)}).delegateTo(document,'[data-formengine-field-change-event="click"]'),new v("change",(t,n)=>{const a=JSON.parse(n.dataset.formengineFieldChangeItems);e.processOnFieldChange(a,t)}).delegateTo(document,'[data-formengine-field-change-event="change"]'),e.formElement.addEventListener("submit",function(t){const n=t.target,a=t.submitter?.name??"";(a===b.save||a===b.saveAndClose||a===b.saveAndView||a===b.saveAndNew||n.querySelector('input[name="_savedok"], input[name="_saveandclosedok"], input[name="_savedokview"], input[name="_savedoknew"]')!==null)&&N(n)},{capture:!0}),window.addEventListener("message",e.handlePostMessage)},e.consume=function(t){if(!t)throw new V.BackendException("No interaction request given",1496589980);let n;const a=new Promise((o,i)=>{n={resolve:o,reject:i}});if(t.concernsTypes(e.consumeTypes)){const o=t.outerMostRequest;e.interactionRequestMap.attachFor(o,n),o.isProcessed()?y(o,o.getProcessedData().response):e.hasChange()||e.isNew()?e.preventExitIfNotSaved(function(i){o.setProcessedData({response:i}),y(o,i)}):e.interactionRequestMap.resolveFor(o)}return a},e.handlePostMessage=function(t){if(!O.MessageUtility.verifyOrigin(t.origin))throw"Denied message sent by "+t.origin;if(t.data.actionName==="typo3:elementBrowser:elementAdded"){if(typeof t.data.fieldName>"u")throw"fieldName not defined in message";if(typeof t.data.value>"u")throw"value not defined in message";const n=t.data.label||t.data.value,a=t.data.title||n,o=D.trimExplode(",",t.data?.exclusiveValues??"");e.setSelectOptionFromExternalSource(t.data.fieldName,t.data.value,n,a,o)}},e.initializeRemainingCharacterViews=function(){document.querySelectorAll('[maxlength]:not([data-input-type="datetimepicker"]):not(.t3js-color-picker)').forEach(n=>{const a=n.closest(".t3js-formengine-field-item");if(a!==null&&a.querySelector("typo3-backend-formengine-char-counter")===null){const o=document.createElement("typo3-backend-formengine-char-counter");o.setAttribute("target",`[data-formengine-input-name="${g`${n.dataset.formengineInputName}`}"]`),a.append(o)}})},e.initializeMinimumCharactersLeftViews=function(){const t=(o,i)=>{const r=i.currentTarget.closest(".t3js-formengine-field-item"),d=r.querySelector(".t3js-charcounter-min"),s=L.get("labels.remainingCharacters",o);if(d)d.querySelector("span").innerHTML=s;else{const u=document.createElement("div");u.classList.add("t3js-charcounter-min");const h=document.createElement("span");h.classList.add("badge","badge-danger"),h.innerHTML=s,u.append(h);let m=r.querySelector(".t3js-charcounter-wrapper");m||(m=document.createElement("div"),m.classList.add("t3js-charcounter-wrapper"),r.append(m)),m.prepend(u)}},n=o=>{const r=o.currentTarget.closest(".t3js-formengine-field-item").querySelector(".t3js-charcounter-min");r&&r.remove()};document.querySelectorAll('[minlength]:not([data-input-type="datetimepicker"]):not(.t3js-charcounter-min-initialized)').forEach(o=>{o.addEventListener("focus",i=>{const r=e.getMinCharacterLeftCount(o);r>0&&t(r,i)}),o.addEventListener("blur",n),o.addEventListener("keyup",i=>{const r=e.getMinCharacterLeftCount(o);r>0?t(r,i):n(i)})})},e.getMinCharacterLeftCount=function(t){const n=t.value,a=t.minLength,o=n.length;if(o===0)return 0;const i=(n.match(/\n/g)||[]).length;return a-o-i},e.initializeNullNoPlaceholderCheckboxes=function(){document.querySelectorAll(".t3-form-field-eval-null-checkbox").forEach(t=>{const n=t.querySelector('input[type="checkbox"]'),a=t.closest(".t3js-formengine-field-item");n.checked||a.classList.add("disabled")})},e.initializeNullWithPlaceholderCheckboxes=function(){document.querySelectorAll(".t3js-form-field-eval-null-placeholder-checkbox").forEach(t=>{e.toggleCheckboxField(t.querySelector('input[type="checkbox"]'),!1)})},e.toggleCheckboxField=function(t,n=!0){const a=t.closest(".t3js-formengine-field-item"),o=a.querySelector(".t3js-formengine-placeholder-placeholder"),i=a.querySelector(".t3js-formengine-placeholder-formfield");t.checked?(o.hidden=!0,i.hidden=!1,n&&i.querySelector("input,select,textarea")?.focus()):(o.hidden=!1,i.hidden=!0)},e.reinitialize=function(){const t=document.querySelectorAll(".t3js-clearable");t.length>0&&import("@typo3/backend/input/clearable.js").then(function(){t.forEach(n=>n.clearable())}),e.initializeNullNoPlaceholderCheckboxes(),e.initializeNullWithPlaceholderCheckboxes(),e.initializeLocalizationStateSelector(),e.initializeMinimumCharactersLeftViews(),e.initializeRemainingCharacterViews()},e.initializeLocalizationStateSelector=function(){document.querySelectorAll(".t3js-l10n-state-container").forEach(t=>{const n=t.closest(".t3js-formengine-field-item")?.querySelector("[data-formengine-input-name]");if(n==null)return;const a=t.querySelector('input[type="radio"]:checked')?.value;a===void 0&&console.warn("The localization state of the field "+n.dataset.formengineInputName+" cannot be determined. This smells like a DataHandler bug."),(a==="parent"||a==="source")&&(n.disabled=!0)})},e.hasChange=function(){const t=c(g`form[name="${e.formName}"] .has-change`).length>0,n=c('[name^="data["].has-change').length>0;return t||n},e.isNew=function(){return document.querySelector('form[name="'+e.formName+'"] .typo3-TCEforms.is-new')!==null},e.markFieldAsChanged=function(t){t.classList.add("has-change");const n=t.closest(".t3js-formengine-palette-field")?.querySelector(".t3js-formengine-label");n!==null&&n.classList.add("has-change")},e.preventExitIfNotSavedCallback=()=>{e.closeDocument()},e.preventFollowLinkIfNotSaved=function(t){return e.preventExitIfNotSaved(function(){window.location.href=t}),!1},e.preventExitIfNotSaved=function(t){if(t=t||e.preventExitIfNotSavedCallback,e.hasChange()||e.isNew()){const n=l.get("label.confirm.close_without_save.title"),a=l.get("label.confirm.close_without_save.content"),o=[{text:l.get("buttons.confirm.close_without_save.no"),btnClass:"btn-default",name:"no"},{text:l.get("buttons.confirm.close_without_save.yes"),btnClass:"btn-default",name:"yes"}];c(".has-error").length===0&&o.push({text:l.get("buttons.confirm.save_and_close"),btnClass:"btn-primary",name:"save",active:!0});const i=f.confirm(n,a,w.warning,o);i.addEventListener("button.clicked",function(r){r.target.name==="no"?i.hideModal():r.target.name==="yes"?(i.hideModal(),t.call(null,!0)):r.target.name==="save"&&(i.hideModal(),e.saveAndCloseDocument())})}else t.call(null,!0)},e.preventSaveIfHasErrors=function(){if(c(".has-error").length>0){const t=TYPO3.lang["label.alert.save_with_error.title"]||"You have errors in your form!",n=TYPO3.lang["label.alert.save_with_error.content"]||"Please check the form, there is at least one error in your form.",a=f.confirm(t,n,w.error,[{text:TYPO3.lang["buttons.alert.save_with_error.ok"]||"OK",btnClass:"btn-danger",name:"ok"}]);return a.addEventListener("button.clicked",function(o){o.target.name==="ok"&&a.hideModal()}),!1}return!0},e.processOnFieldChange=function(t,n){t.forEach(a=>{const o=k.get(a.name);o instanceof Function&&o.call(null,a.data||null,n)})},e.registerOnFieldChangeHandler=function(t,n){k.has(t)&&console.warn("Handler for onFieldChange name `"+t+"` has been overridden."),k.set(t,n)},e.closeModalsRecursive=function(){typeof f.currentModal<"u"&&f.currentModal!==null&&(f.currentModal.addEventListener("typo3-modal-hidden",function(){e.closeModalsRecursive()}),f.currentModal.hideModal())},e.disableDocHeaderButtons=function(){const t=document.querySelector(".t3js-module-docheader-buttons");t&&t.querySelectorAll('button, a, input[type="submit"]').forEach(n=>{n instanceof HTMLButtonElement||n instanceof HTMLInputElement?n.disabled=!0:n instanceof HTMLAnchorElement&&(n.classList.add("disabled"),n.setAttribute("aria-disabled","true"))})},e.enableDocHeaderButtons=function(){const t=document.querySelector(".t3js-module-docheader-buttons");t&&t.querySelectorAll('button, a, input[type="submit"]').forEach(n=>{n instanceof HTMLButtonElement||n instanceof HTMLInputElement?n.disabled=!1:n instanceof HTMLAnchorElement&&(n.classList.remove("disabled"),n.removeAttribute("aria-disabled"))})},e.previewAction=function(t,n){n=n||e.previewActionCallback;const a=t.target.href,o="isNew"in t.target.dataset,i=c("<input />").attr("type","hidden").attr("name",b.saveAndView).attr("value","1");e.hasChange()||e.isNew()?e.showPreviewModal(a,o,i,n):(c(g`form[name="${e.formName}"]`).append(i),window.open("","newTYPO3frontendWindow"),e.formElement.submit())},e.previewActionCallback=function(t,n,a){switch(f.dismiss(),t){case"discard":const o=window.open(n,"newTYPO3frontendWindow");o.focus(),D.urlsPointToSameServerSideResource(o.location.href,n)&&o.location.reload();break;case"save":c(g`form[name="${e.formName}"]`).append(c(a)),window.open("","newTYPO3frontendWindow"),e.saveDocument();break;default:break}},e.showPreviewModal=function(t,n,a,o){const i=l.get("label.confirm.view_record_changed.title"),r={text:l.get("buttons.confirm.view_record_changed.cancel"),btnClass:"btn-default",name:"cancel"},d={text:l.get("buttons.confirm.view_record_changed.no-save"),btnClass:"btn-default",name:"discard"},s={text:l.get("buttons.confirm.view_record_changed.save"),btnClass:"btn-primary",name:"save",active:!0};let u=[],h=[];if(n){if(!e.Validation.isValid()){e.Validation.showErrorModal();return}u=[r,s],h=[l.get("label.confirm.view_record_changed.content.is-new-page")]}else u=[r,d],h=[l.get("label.confirm.view_record_changed.content")],e.Validation.isValid()?u.push(s):h.push(l.get("label.confirm.view_record_changed.invalid_form"));const m=document.createElement("p");h.forEach((E,S)=>{m.append(E),S!==h.length-1&&m.append(document.createElement("br"))});const _=f.confirm(i,m,w.info,u);_.addEventListener("button.clicked",function(E){o(E.target.name,t,a,_)})},e.newAction=function(t,n){n=n||e.newActionCallback;const a=c("<input />").attr("type","hidden").attr("name",b.saveAndNew).attr("value","1"),o="isNew"in t.target.dataset;e.hasChange()||e.isNew()?e.showNewModal(o,a,n):(c(g`form[name="${e.formName}"]`).append(a),e.formElement.submit())},e.newActionCallback=function(t,n){const a=c(g`form[name="${e.formName}"]`);switch(f.dismiss(),t){case"no":a.append(n),e.formElement.submit();break;case"yes":a.append(n),e.saveDocument();break;default:break}},e.showNewModal=function(t,n,a){const o=l.get("label.confirm.new_record_changed.title"),i=l.get("label.confirm.new_record_changed.content");let r=[];const d={text:l.get("buttons.confirm.new_record_changed.cancel"),btnClass:"btn-default",name:"cancel"},s={text:l.get("buttons.confirm.new_record_changed.no"),btnClass:"btn-default",name:"no"},u={text:l.get("buttons.confirm.new_record_changed.yes"),btnClass:"btn-primary",name:"yes",active:!0};t?r=[d,u]:r=[d,s,u],f.confirm(o,i,w.info,r).addEventListener("button.clicked",function(m){a(m.target.name,n)})},e.duplicateAction=function(t,n){n=n||e.duplicateActionCallback;const a=c("<input />").attr("type","hidden").attr("name",b.duplicate).attr("value","1"),o="isNew"in t.target.dataset;e.hasChange()||e.isNew()?e.showDuplicateModal(o,a,n):(c(g`form[name="${e.formName}"]`).append(a),e.formElement.submit())},e.duplicateActionCallback=function(t,n){const a=c(g`form[name="${e.formName}"]`);switch(f.dismiss(),t){case"no":a.append(n),e.formElement.submit();break;case"yes":a.append(n),e.saveDocument();break;default:break}},e.showDuplicateModal=function(t,n,a){const o=l.get("label.confirm.duplicate_record_changed.title"),i=l.get("label.confirm.duplicate_record_changed.content");let r=[];const d={text:l.get("buttons.confirm.duplicate_record_changed.cancel"),btnClass:"btn-default",name:"cancel"},s={text:l.get("button.confirm.duplicate_record_changed.no"),btnClass:"btn-default",name:"no"},u={text:l.get("buttons.confirm.duplicate_record_changed.yes"),btnClass:"btn-primary",name:"yes",active:!0};t?r=[d,u]:r=[d,s,u],f.confirm(o,i,w.info,r).addEventListener("button.clicked",function(m){a(m.target.name,n)})},e.deleteAction=function(t,n){n=n||e.deleteActionCallback;const a=c(t.target);e.showDeleteModal(a,n)},e.deleteActionCallback=function(t,n){f.dismiss(),t==="yes"&&e.invokeRecordDeletion(n)},e.showDeleteModal=function(t,n){const a=l.get("label.confirm.delete_record.title");let o=l.get("label.confirm.delete_record.content");t.data("reference-count-message")&&(o+=`
`+t.data("reference-count-message")),t.data("translation-count-message")&&(o+=`
`+t.data("translation-count-message")),f.confirm(a,o,w.warning,[{text:l.get("buttons.confirm.delete_record.no"),btnClass:"btn-default",name:"no"},{text:l.get("buttons.confirm.delete_record.yes"),btnClass:"btn-warning",name:"yes",active:!0}]).addEventListener("button.clicked",function(r){n(r.target.name,t)})},e.enableOptGroup=function(t){const n=t.parentElement;n instanceof HTMLOptGroupElement&&n.querySelectorAll("option:not([hidden]):not([disabled]):not(.hidden)").length&&(n.hidden=!1,n.disabled=!1,n.classList.remove("hidden"))},e.closeDocument=function(){e.formElement.closeDoc.value=1,e.formElement.submit()};const N=t=>{if(t.querySelector('input[name="doSave"]')===null){const n=document.createElement("input");n.type="hidden",n.name="doSave",n.value="1",t.append(n)}},T=t=>{const n=document.activeElement;(n instanceof HTMLInputElement||n instanceof HTMLSelectElement||n instanceof HTMLTextAreaElement)&&n.blur(),N(e.formElement);const a=document.querySelector(g`button[name="${t}"][form="${e.formElement.id}"]`);if(a!==null)e.formElement.requestSubmit(a);else{const o=document.createElement("input");o.type="hidden",o.name=t,o.value="1",e.formElement.append(o),e.formElement.requestSubmit()}};return e.saveDocument=function(){T(b.save)},e.saveAndCloseDocument=function(){T(b.saveAndClose)},e.initialize=function(t){e.browserUrl=t,P.ready().then(()=>{e.initializeEvents(),e.Validation.initialize(this),e.reinitialize(),c("#t3js-ui-block").remove(),e.enableDocHeaderButtons(),e.formElement.dispatchEvent(new Event("typo3:form-engine:ready")),x=!0,M.setScope("backend/form-engine"),M.register([M.normalizedCtrlModifierKey,"s"],n=>{n.preventDefault(),e.saveDocument()},{scope:"backend/form-engine",allowOnEditables:!0}),M.register([M.normalizedCtrlModifierKey,B.SHIFT,"s"],n=>{n.preventDefault(),e.saveAndCloseDocument()},{scope:"backend/form-engine",allowOnEditables:!0})})},e.invokeRecordDeletion=function(t){window.location.href=t.attr("href")},TYPO3.FormEngine=e,e}();export{R as default};
