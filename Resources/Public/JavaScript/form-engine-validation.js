/*
 * This file is part of the TYPO3 CMS project.
 *
 * It is free software; you can redistribute it and/or modify it under
 * the terms of the GNU General Public License, either version 2
 * of the License, or any later version.
 *
 * For the full copyright and license information, please read the
 * LICENSE.txt file that was distributed with this source code.
 *
 * The TYPO3 project - inspiring people to share!
 */
import{DateTime}from"luxon";import Md5 from"@typo3/backend/hashing/md5.js";import Modal from"@typo3/backend/modal.js";import Severity from"@typo3/backend/severity.js";import Utility from"@typo3/backend/utility.js";import RegularEvent from"@typo3/core/event/regular-event.js";import DomHelper from"@typo3/backend/utility/dom-helper.js";import{selector}from"@typo3/core/literals.js";import SubmitInterceptor from"@typo3/backend/form/submit-interceptor.js";export default(function(){const FormEngineValidation={rulesSelector:"[data-formengine-validation-rules]",inputSelector:"[data-formengine-input-params]",markerSelector:".t3js-formengine-validation-marker",groupFieldHiddenElement:".t3js-formengine-field-group input[type=hidden]",relatedFieldSelector:"[data-relatedfieldname]",errorClass:"has-error",lastYear:0,lastDate:0,lastTime:0,passwordDummy:"********"};let formEngineFormElement,validationSuspended=!1;const customEvaluations=new Map;return FormEngineValidation.initialize=function(e){formEngineFormElement=e,formEngineFormElement.querySelectorAll("."+FormEngineValidation.errorClass).forEach((e=>e.classList.remove(FormEngineValidation.errorClass))),FormEngineValidation.initializeInputFields(),new RegularEvent("change",((e,t)=>{FormEngineValidation.validateField(t),FormEngineValidation.markFieldAsChanged(t)})).delegateTo(formEngineFormElement,FormEngineValidation.rulesSelector),FormEngineValidation.registerSubmitCallback(),FormEngineValidation.validate()},FormEngineValidation.initializeInputFields=function(){formEngineFormElement.querySelectorAll(FormEngineValidation.inputSelector).forEach((e=>{const t=JSON.parse(e.dataset.formengineInputParams).field,n=formEngineFormElement.querySelector(selector`[name="${t}"]`);"formengineInputInitialized"in e.dataset||(n.dataset.config=e.dataset.formengineInputParams,FormEngineValidation.initializeInputField(t))}))},FormEngineValidation.initializeInputField=function(e){const t=formEngineFormElement.querySelector(selector`[name="${e}"]`),n=formEngineFormElement.querySelector(selector`[data-formengine-input-name="${e}"]`);if(void 0!==t.dataset.config){const e=JSON.parse(t.dataset.config),a=FormEngineValidation.formatByEvals(e,t.value);a.length&&(n.value=a)}new RegularEvent("change",(()=>{FormEngineValidation.updateInputField(n.dataset.formengineInputName)})).bindTo(n),n.dataset.formengineInputInitialized="true"},FormEngineValidation.registerCustomEvaluation=function(e,t){customEvaluations.has(e)||customEvaluations.set(e,t)},FormEngineValidation.formatByEvals=function(e,t){if(void 0!==e.evalList){const n=Utility.trimExplode(",",e.evalList);for(const e of n)t=FormEngineValidation.formatValue(e,t)}return t},FormEngineValidation.formatValue=function(e,t){let n="";switch(e){case"date":case"datetime":case"time":case"timesec":if(""===t||"0"===t)return"";const e=DateTime.fromISO(String(t),{zone:"utc"});if(e.isValid)return e.toISO({suppressMilliseconds:!0});const a="number"==typeof t?t:parseInt(t,10);if(isNaN(a))n="";else{n=DateTime.fromSeconds(a,{zone:"utc"}).toISO({suppressMilliseconds:!0})}break;case"password":n=t?FormEngineValidation.passwordDummy:"";break;default:n=t.toString()}return n},FormEngineValidation.updateInputField=function(e){const t=formEngineFormElement.querySelector(selector`[name="${e}"]`),n=formEngineFormElement.querySelector(selector`[data-formengine-input-name="${e}"]`);if(void 0!==t.dataset.config){const e=JSON.parse(t.dataset.config),a=FormEngineValidation.processByEvals(e,n.value),i=FormEngineValidation.formatByEvals(e,a);t.value!==a&&(t.disabled&&t.dataset.enableOnModification&&(t.disabled=!1),t.value=a,t.dispatchEvent(new Event("change"))),n.value!==i&&(n.value=i)}},FormEngineValidation.validateField=function(e,t){if(t=t||e.value||"",void 0===e.dataset.formengineValidationRules)return t;const n=JSON.parse(e.dataset.formengineValidationRules);let a=!1,i=0;const o=t;let r,l,s;Array.isArray(t)||(t=t.trimStart());for(const o of n){if(a)break;switch(o.type){case"required":""===t&&(a=!0,e.closest(FormEngineValidation.markerSelector).classList.add(FormEngineValidation.errorClass));break;case"range":if(""!==t){if((o.minItems||o.maxItems)&&(r=formEngineFormElement.querySelector(selector`[name="${e.dataset.relatedfieldname}"]`),i=null!==r?Utility.trimExplode(",",r.value).length:parseInt(e.value,10),void 0!==o.minItems&&(l=1*o.minItems,!isNaN(l)&&i<l&&(a=!0)),void 0!==o.maxItems&&(s=1*o.maxItems,!isNaN(s)&&i>s&&(a=!0))),void 0!==o.lower)if("datetimepicker"===e.dataset.inputType){const e=DateTime.fromISO(t,{zone:"utc"}),n=DateTime.fromISO(o.lower,{zone:"utc"});(!e.isValid||e<n.minus(1e3*n.second))&&(a=!0)}else{const e=1*o.lower;!isNaN(e)&&parseInt(t,10)<e&&(a=!0)}if(void 0!==o.upper)if("datetimepicker"===e.dataset.inputType){const e=DateTime.fromISO(t,{zone:"utc"}),n=DateTime.fromISO(o.upper,{zone:"utc"});(!e.isValid||e>n.plus(1e3*(59-n.second)))&&(a=!0)}else{const e=1*o.upper;!isNaN(e)&&parseInt(t,10)>e&&(a=!0)}}break;case"select":case"category":(o.minItems||o.maxItems)&&(r=formEngineFormElement.querySelector(selector`[name="${e.dataset.relatedfieldname}"]`),i=null!==r?Utility.trimExplode(",",r.value).length:e instanceof HTMLSelectElement?e.querySelectorAll("option:checked").length:e.querySelectorAll("input[value]:checked").length,void 0!==o.minItems&&(l=1*o.minItems,!isNaN(l)&&i<l&&(a=!0)),void 0!==o.maxItems&&(s=1*o.maxItems,!isNaN(s)&&i>s&&(a=!0)));break;case"group":case"folder":case"inline":(o.minItems||o.maxItems)&&(i=Utility.trimExplode(",",e.value).length,void 0!==o.minItems&&(l=1*o.minItems,!isNaN(l)&&i<l&&(a=!0)),void 0!==o.maxItems&&(s=1*o.maxItems,!isNaN(s)&&i>s&&(a=!0)));break;case"min":(e instanceof HTMLInputElement||e instanceof HTMLTextAreaElement)&&e.value.length>0&&e.value.length<e.minLength&&(a=!0)}}const m=!a,d=e.closest(FormEngineValidation.markerSelector);return null!==d&&d.classList.toggle(FormEngineValidation.errorClass,!m),FormEngineValidation.markParentTab(e,m),formEngineFormElement.dispatchEvent(new CustomEvent("t3-formengine-postfieldvalidation",{detail:{field:e,isValid:m},cancelable:!1,bubbles:!0})),o},FormEngineValidation.processByEvals=function(e,t){if(void 0!==e.evalList){const n=Utility.trimExplode(",",e.evalList);for(const a of n)t=FormEngineValidation.processValue(a,t,e)}return t},FormEngineValidation.processValue=function(e,t,n){let a="",i="",o=0,r=t;switch(e){case"alpha":case"num":case"alphanum":case"alphanum_x":for(a="",o=0;o<t.length;o++){const n=t.substr(o,1);let i="_"===n||"-"===n,r=n>="a"&&n<="z"||n>="A"&&n<="Z",l=n>="0"&&n<="9";switch(e){case"alphanum":i=!1;break;case"alpha":l=!1,i=!1;break;case"num":r=!1,i=!1}(r||l||i)&&(a+=n)}a!==t&&(r=a);break;case"is_in":if(n.is_in){i=""+t,n.is_in=n.is_in.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&");const e=new RegExp("[^"+n.is_in+"]+","g");a=i.replace(e,"")}else a=i;r=a;break;case"nospace":r=(""+t).replace(/ /g,"");break;case"md5":""!==t&&(r=Md5.hash(t));break;case"upper":r=t.toUpperCase();break;case"lower":r=t.toLowerCase();break;case"integer":""!==t&&(r=FormEngineValidation.parseInt(t).toString());break;case"decimal":""!==t&&(r=FormEngineValidation.parseDouble(t));break;case"trim":r=String(t).trim();break;case"time":case"timesec":if(""!==t){r=DateTime.fromISO(t,{zone:"utc"}).set({year:1970,month:1,day:1}).toISO({suppressMilliseconds:!0})}break;case"year":if(""!==t){let e=parseInt(t,10);isNaN(e)&&(e=(new Date).getUTCFullYear()),r=e.toString(10)}break;case"null":case"password":break;default:customEvaluations.has(e)?r=customEvaluations.get(e).call(null,t):"object"==typeof TBE_EDITOR&&void 0!==TBE_EDITOR.customEvalFunctions&&"function"==typeof TBE_EDITOR.customEvalFunctions[e]&&(r=TBE_EDITOR.customEvalFunctions[e](t))}return r},FormEngineValidation.validate=function(e){(void 0===e||e instanceof Document)&&formEngineFormElement.querySelectorAll(FormEngineValidation.markerSelector+", .t3js-tabmenu-item").forEach((e=>{e.classList.remove(FormEngineValidation.errorClass,"has-validation-error")}));const t=e||document;for(const e of t.querySelectorAll(FormEngineValidation.rulesSelector))if(null===e.closest(".t3js-flex-section-deleted, .t3js-inline-record-deleted, .t3js-file-reference-deleted")){let t=!1;const n=e.value,a=FormEngineValidation.validateField(e,n);if(Array.isArray(a)&&Array.isArray(n)){if(a.length!==n.length)t=!0;else for(let e=0;e<a.length;e++)if(a[e]!==n[e]){t=!0;break}}else a.length&&n!==a&&(t=!0);t&&(e.disabled&&e.dataset.enableOnModification&&(e.disabled=!1),e.value=a)}},FormEngineValidation.markFieldAsChanged=function(e){e.classList.add("has-change");const t=e.closest(".t3js-formengine-palette-field")?.querySelector(".t3js-formengine-label");null!==t&&t.classList.add("has-change")},FormEngineValidation.parseInt=function(e){if(!e)return 0;const t=parseInt(""+e,10);return isNaN(t)?0:t},FormEngineValidation.parseDouble=function(e,t=2){let n=""+e;n=n.replace(/[^0-9,.-]/g,"");const a=n.startsWith("-");n=n.replace(/-/g,""),n=n.replace(/,/g,"."),-1===n.indexOf(".")&&(n+=".0");const i=n.split("."),o=i.pop();let r=Number(i.join("")+"."+o);return a&&(r*=-1),n=r.toFixed(t),n},FormEngineValidation.pol=function(foreign,value){return eval(("-"==foreign?"-":"")+value)},FormEngineValidation.markParentTab=function(e,t){DomHelper.parents(e,".tab-pane").forEach((e=>{t&&(t=null===e.querySelector(".has-error"));const n=e.id;formEngineFormElement.querySelector('[data-bs-target="#'+n+'"]').closest(".t3js-tabmenu-item").classList.toggle("has-validation-error",!t)}))},FormEngineValidation.suspend=function(){validationSuspended=!0},FormEngineValidation.resume=function(){validationSuspended=!1},FormEngineValidation.registerSubmitCallback=function(){new SubmitInterceptor(formEngineFormElement).addPreSubmitCallback((()=>{if(validationSuspended||null===document.querySelector("."+FormEngineValidation.errorClass))return!0;const e=Modal.confirm(TYPO3.lang.alert||"Alert",TYPO3.lang["FormEngine.fieldsMissing"],Severity.error,[{text:TYPO3.lang["button.ok"]||"OK",active:!0,btnClass:"btn-default",name:"ok"}]);return e.addEventListener("button.clicked",(()=>e.hideModal())),!1}))},FormEngineValidation}());