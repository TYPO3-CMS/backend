/*
 * This file is part of the TYPO3 CMS project.
 *
 * It is free software; you can redistribute it and/or modify it under
 * the terms of the GNU General Public License, either version 2
 * of the License, or any later version.
 *
 * For the full copyright and license information, please read the
 * LICENSE.txt file that was distributed with this source code.
 *
 * The TYPO3 project - inspiring people to share!
 */
var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,i,o){void 0===o&&(o=i),Object.defineProperty(e,o,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,o){void 0===o&&(o=i),e[o]=t[i]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&__createBinding(t,e,i);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};define(["require","exports","d3-selection","TYPO3/CMS/Core/Ajax/AjaxRequest","../SvgTree","./PageTreeDragDrop","../ContextMenu","../Storage/Persistent","../Enum/KeyTypes"],(function(e,t,i,o,d,s,r,n,a){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PageTree=void 0,i=__importStar(i),o=__importDefault(o),n=__importDefault(n);class l extends d.SvgTree{constructor(){super(),this.networkErrorTitle=TYPO3.lang.pagetree_networkErrorTitle,this.networkErrorMessage=TYPO3.lang.pagetree_networkErrorDesc,this.settings.defaultProperties={hasChildren:!1,nameSourceField:"title",itemType:"pages",prefix:"",suffix:"",locked:!1,loaded:!1,overlayIcon:"",selectable:!0,expanded:!1,checked:!1,backgroundColor:"",stopPageTree:!1,class:"",readableRootline:"",isMountPoint:!1},this.dispatch.on("nodeSelectedAfter.pageTree",e=>this.nodeSelectedAfter(e)),this.dispatch.on("nodeRightClick.pageTree",e=>this.nodeRightClick(e)),this.dispatch.on("prepareLoadedNode.pageTree",e=>this.prepareLoadedNode(e))}initialize(e,t,i){super.initialize(e,t),this.dragDrop=i}sendChangeCommand(e){let t="",i=0;e.target&&(i=e.target.identifier,"after"===e.position&&(i=-i)),"new"===e.command?t="&data[pages][NEW_1][pid]="+i+"&data[pages][NEW_1][title]="+encodeURIComponent(e.name)+"&data[pages][NEW_1][doktype]="+e.type:"edit"===e.command?t="&data[pages]["+e.uid+"]["+e.nameSourceField+"]="+encodeURIComponent(e.title):"delete"===e.command?(e.uid===window.fsMod.recentIds.web&&this.selectNode(this.nodes[0]),t="&cmd[pages]["+e.uid+"][delete]=1"):t="cmd[pages]["+e.uid+"]["+e.command+"]="+i,this.nodesAddPlaceholder(),new o.default(top.TYPO3.settings.ajaxUrls.record_process).post(t,{headers:{"Content-Type":"application/x-www-form-urlencoded","X-Requested-With":"XMLHttpRequest"}}).then(e=>e.resolve()).then(e=>{e&&e.hasErrors?(this.errorNotification(e.messages,!1),this.nodesContainer.selectAll(".node").remove(),this.updateVisibleNodes(),this.nodesRemovePlaceholder()):this.refreshOrFilterTree()}).catch(e=>{this.errorNotification(e)})}nodeRightClick(e){r.show(e.itemType,parseInt(e.identifier,10),"tree","","",this.getNodeElement(e))}prepareLoadedNode(e){e.stateIdentifier===top.window.fsMod.navFrameHighlightedID.web&&(e.checked=!0)}hideChildren(e){super.hideChildren(e),n.default.set("BackendComponents.States.Pagetree.stateHash."+e.stateIdentifier,"0")}showChildren(e){this.loadChildrenOfNode(e),super.showChildren(e),n.default.set("BackendComponents.States.Pagetree.stateHash."+e.stateIdentifier,"1")}updateNodeBgClass(e){return super.updateNodeBgClass.call(this,e).call(this.initializeDragForNode())}nodesUpdate(e){return(e=super.nodesUpdate.call(this,e).call(this.initializeDragForNode())).append("text").text("+").attr("class","node-stop").attr("dx",30).attr("dy",5).attr("visibility",e=>e.stopPageTree&&0!==e.depth?"visible":"hidden").on("click",(e,t)=>{document.dispatchEvent(new CustomEvent("typo3:pagetree:mountPoint",{detail:{pageId:parseInt(t.identifier,10)}}))}),e}selectNode(e){this.isNodeSelectable(e)&&(this.disableSelectedNodes(),e.checked=!0,this.dispatch.call("nodeSelectedAfter",this,e),this.updateVisibleNodes())}switchFocusNode(e){this.nodeIsEdit||this.switchFocus(this.getNodeElement(e))}initializeDragForNode(){return this.dragDrop.connectDragHandler(new s.PageTreeNodeDragHandler(this,this.dragDrop))}removeEditedText(){const e=i.selectAll(".node-edit");if(e.size())try{e.remove(),this.nodeIsEdit=!1}catch(e){}}loadChildrenOfNode(e){e.loaded||(this.nodesAddPlaceholder(),new o.default(this.settings.dataUrl+"&pid="+e.identifier+"&mount="+e.mountPoint+"&pidDepth="+e.depth).get({cache:"no-cache"}).then(e=>e.resolve()).then(t=>{let i=Array.isArray(t)?t:[];i.shift();const o=this.nodes.indexOf(e)+1;i.forEach((e,t)=>{this.nodes.splice(o+t,0,e)}),e.loaded=!0,this.setParametersNode(),this.prepareDataForVisibleNodes(),this.updateVisibleNodes(),this.nodesRemovePlaceholder(),this.switchFocusNode(e)}).catch(e=>{throw this.errorNotification(e,!1),this.nodesRemovePlaceholder(),e}))}nodeSelectedAfter(e){if(!e.checked)return;top.window.fsMod.recentIds.web=e.identifier,top.window.fsMod.currentBank=e.stateIdentifier.split("_")[0],top.window.fsMod.navFrameHighlightedID.web=e.stateIdentifier;let t="?";-1!==top.window.currentSubScript.indexOf("?")&&(t="&"),top.TYPO3.Backend.ContentContainer.setUrl(top.window.currentSubScript+t+"id="+e.identifier)}appendTextElement(e){let t=0;return super.appendTextElement(e).attr("dx",e=>{let t=this.textPosition;return e.stopPageTree&&0!==e.depth&&(t+=15),e.locked&&(t+=15),t}).on("click",(e,i)=>{"0"!==i.identifier?1==++t&&setTimeout(()=>{1===t?this.selectNode(i):this.editNodeLabel(i),t=0},300):this.selectNode(i)})}sendEditNodeLabelCommand(e){const t="&data[pages]["+e.identifier+"]["+e.nameSourceField+"]="+encodeURIComponent(e.newName);this.nodesAddPlaceholder(e),new o.default(top.TYPO3.settings.ajaxUrls.record_process).post(t,{headers:{"Content-Type":"application/x-www-form-urlencoded","X-Requested-With":"XMLHttpRequest"}}).then(e=>e.resolve()).then(t=>{t&&t.hasErrors?this.errorNotification(t.messages,!1):e.name=e.newName,this.refreshOrFilterTree()}).catch(e=>{this.errorNotification(e,!0)})}editNodeLabel(e){e.allowEdit&&(this.removeEditedText(),this.nodeIsEdit=!0,i.select(this.svg.node().parentNode).append("input").attr("class","node-edit").style("top",()=>e.y+this.settings.marginTop+"px").style("left",e.x+this.textPosition+5+"px").style("width",this.settings.width-(e.x+this.textPosition+20)+"px").style("height",this.settings.nodeHeight+"px").attr("type","text").attr("value",e.name).on("keydown",t=>{const i=t.keyCode;if(i===a.KeyTypesEnum.ENTER||i===a.KeyTypesEnum.TAB){const i=t.target.value.trim();this.nodeIsEdit=!1,this.removeEditedText(),i.length&&i!==e.name&&(e.nameSourceField=e.nameSourceField||"title",e.newName=i,this.sendEditNodeLabelCommand(e))}else i===a.KeyTypesEnum.ESCAPE&&(this.nodeIsEdit=!1,this.removeEditedText())}).on("blur",t=>{if(!this.nodeIsEdit)return;const i=t.target.value.trim();i.length&&i!==e.name&&(e.nameSourceField=e.nameSourceField||"title",e.newName=i,this.sendEditNodeLabelCommand(e)),this.removeEditedText()}).node().select())}}t.PageTree=l}));