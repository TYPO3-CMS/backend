/*
 * This file is part of the TYPO3 CMS project.
 *
 * It is free software; you can redistribute it and/or modify it under
 * the terms of the GNU General Public License, either version 2
 * of the License, or any later version.
 *
 * For the full copyright and license information, please read the
 * LICENSE.txt file that was distributed with this source code.
 *
 * The TYPO3 project - inspiring people to share!
 */
import{LitElement as z,html as u,nothing as x}from"lit";import{property as h,state as $,query as D,customElement as Y}from"lit/decorators.js";import{unsafeHTML as P}from"lit/directives/unsafe-html.js";import{classMap as O}from"lit/directives/class-map.js";import{ifDefined as R}from"lit/directives/if-defined.js";import{classesArrayToClassInfo as g}from"@typo3/core/lit-helper.js";import A from"@typo3/core/event/regular-event.js";import{SeverityEnum as f}from"@typo3/backend/enum/severity.js";import L from"@typo3/core/ajax/ajax-request.js";import T from"@typo3/backend/severity.js";import"@typo3/backend/element/icon-element.js";import"@typo3/backend/element/spinner-element.js";var d=function(l,t,e,s){var a=arguments.length,o=a<3?t:s===null?s=Object.getOwnPropertyDescriptor(t,e):s,c;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(l,t,e,s);else for(var m=l.length-1;m>=0;m--)(c=l[m])&&(o=(a<3?c(o):a>3?c(t,e,o):c(t,e))||o);return a>3&&o&&Object.defineProperty(t,e,o),o},M;(function(l){l.modal=".t3js-modal",l.header=".t3js-modal-header",l.close=".t3js-modal-close",l.body=".t3js-modal-body",l.footer=".t3js-modal-footer"})(M||(M={}));var p;(function(l){l.small="small",l.default="default",l.medium="medium",l.large="large",l.full="full"})(p||(p={}));var b;(function(l){l.default="default",l.light="light",l.dark="dark"})(b||(b={}));var i;(function(l){l.default="default",l.template="template",l.ajax="ajax",l.iframe="iframe"})(i||(i={}));let q=0,n=class extends z{constructor(){super(),this.modalTitle="",this.content="",this.type=i.default,this.severity=f.notice,this.variant=b.default,this.size=p.default,this.staticBackdrop=!1,this.hideCloseButton=!1,this.additionalCssClasses=[],this.buttons=[],this.templateResultContent=null,this.activeButton=null,this.callback=null,this.ajaxCallback=null,this.userData={},this.uniqueId=++q}setContent(t){this.templateResultContent=t}hideModal(){this.doHideModal()}async doHideModal(){this.trigger("typo3-modal-hide"),this.dialog.classList.add("modal-closing");const t=new Promise(s=>this.dialog.addEventListener("transitionend",s,{once:!0})),e=new Promise(s=>setTimeout(s,305));await Promise.race([t,e]),this.dialog.classList.remove("modal-closing"),this.dialog.close()}createRenderRoot(){return this}async showModal(){this.trigger("typo3-modal-show"),this.dialog.showModal();const t=new Promise(s=>this.dialog.addEventListener("transitionend",s,{once:!0})),e=new Promise(s=>setTimeout(s,305));await Promise.race([t,e]),this.trigger("typo3-modal-shown")}firstUpdated(){this.showModal(),this.callback&&this.callback(this)}updated(t){t.has("templateResultContent")&&this.dispatchEvent(new CustomEvent("modal-updated",{bubbles:!0}))}render(){const t=g(["modal","t3js-modal",`modal-type-${this.type}`,`modal-style-${this.variant}`,`modal-severity-${T.getCssClass(this.severity)}`,`modal-size-${this.size}`,...this.additionalCssClasses]);return u`<dialog class=${O(t)} aria-labelledby=t3-modal-header-${this.uniqueId} @close=${this.handleDialogClose} @cancel=${this.handleDialogCancel} @click=${this.handleDialogClick}><div class="modal-header t3js-modal-header"><div class="modal-header-title t3js-modal-title" id=t3-modal-header-${this.uniqueId}>${this.modalTitle}</div>${this.hideCloseButton?x:u`<button class="modal-header-close t3js-modal-close" @click=${()=>this.hideModal()}><typo3-backend-icon identifier=actions-close size=small></typo3-backend-icon><span class=visually-hidden>${TYPO3?.lang?.["button.close"]||"Close"} ${this.modalTitle}</span></button>`}</div><div class="modal-body t3js-modal-body">${this.renderModalBody()}</div>${this.buttons.length===0?x:u`<div class="modal-footer t3js-modal-footer">${this.buttons.map(e=>this.renderModalButton(e))}</div>`}</dialog>`}handleDialogClose(){this.trigger("typo3-modal-hidden")}handleDialogCancel(t){t.preventDefault(),this.hideModal()}handleDialogClick(t){t.target===this.dialog&&(this.staticBackdrop?(t.preventDefault(),this.shake()):this.hideModal())}_buttonClick(t,e){const s=t.currentTarget;e.action?(this.activeButton=e,e.action.execute(s).then(()=>this.hideModal())):e.trigger&&e.trigger(t,this),s.dispatchEvent(new CustomEvent("button.clicked",{bubbles:!0}))}renderAjaxBody(){return this.templateResultContent===null?(new L(this.content).get().then(async t=>{const e=await t.raw().text();this.templateResultContent=u`${P(e)}`,this.updateComplete.then(()=>{this.ajaxCallback&&this.ajaxCallback(this),this.dispatchEvent(new CustomEvent("modal-loaded"))})}).catch(async t=>{const e=await t.raw().text();e?this.templateResultContent=u`${P(e)}`:this.templateResultContent=u`<p><strong>Oops, received a ${t.response.status} response from </strong><span class=text-break>${this.content}</span>.</p>`}),u`<div class=modal-loading><typo3-backend-spinner size=large></typo3-backend-spinner></div>`):this.templateResultContent}renderModalBody(){if(this.type===i.iframe){const t=e=>{const s=e.currentTarget;s.contentDocument.title&&(this.modalTitle=s.contentDocument.title)};return u`<iframe src=${this.content} name=modal_frame class="modal-iframe t3js-modal-iframe" @load=${t}></iframe>`}return this.type===i.ajax?this.renderAjaxBody():this.type===i.template?this.templateResultContent:u`<p>${this.content}</p>`}renderModalButton(t){const s={btn:!0,[t.btnClass||"btn-default"]:!0,"t3js-active":t.active,disabled:this.activeButton&&this.activeButton!==t};return u`<button class=${O(s)} name=${R(t.name||void 0)} form=${R(t.form||void 0)} @click=${a=>this._buttonClick(a,t)}>${t.icon?u`<typo3-backend-icon identifier=${t.icon} size=small></typo3-backend-icon>`:x} ${t.text}</button>`}trigger(t){this.dispatchEvent(new CustomEvent(t,{bubbles:!0,composed:!0}))}shake(){window.matchMedia("(prefers-reduced-motion: reduce)").matches||this.dialog.animate([{transform:"translateX(0px)"},{transform:"translateX(-2px)"},{transform:"translateX(0px)"},{transform:"translateX(2px)"},{transform:"translateX(0px)"}],150)}};d([h({type:String,reflect:!0})],n.prototype,"modalTitle",void 0),d([h({type:String,reflect:!0})],n.prototype,"content",void 0),d([h({type:String,reflect:!0})],n.prototype,"type",void 0),d([h({type:String,reflect:!0})],n.prototype,"severity",void 0),d([h({type:String,reflect:!0})],n.prototype,"variant",void 0),d([h({type:String,reflect:!0})],n.prototype,"size",void 0),d([h({type:Boolean})],n.prototype,"staticBackdrop",void 0),d([h({type:Boolean})],n.prototype,"hideCloseButton",void 0),d([h({type:Array})],n.prototype,"additionalCssClasses",void 0),d([h({type:Array,attribute:!1})],n.prototype,"buttons",void 0),d([$()],n.prototype,"templateResultContent",void 0),d([$()],n.prototype,"activeButton",void 0),d([D("dialog",!0)],n.prototype,"dialog",void 0),n=d([Y("typo3-backend-modal")],n);class w{constructor(){this.sizes=p,this.styles=b,this.types=i,this.currentModal=null,this.instances=[],this.defaultConfiguration={type:i.default,title:"Information",content:"No content provided, please check your <code>Modal</code> configuration.",severity:f.notice,buttons:[],style:b.default,size:p.default,additionalCssClasses:[],callback:null,ajaxCallback:null,staticBackdrop:!1,hideCloseButton:!1},this.initializeMarkupTrigger(document)}static createModalResponseEventFromElement(t,e){return t.dataset.eventName?new CustomEvent(t.dataset.eventName,{bubbles:!0,detail:{result:e,payload:t.dataset.eventPayload||null}}):null}dismiss(){this.currentModal&&this.currentModal.hideModal()}confirm(t,e,s=f.warning,a=[],o){a.length===0&&a.push({text:TYPO3?.lang?.["button.cancel"]||"Cancel",active:!0,btnClass:"btn-default",name:"cancel"},{text:TYPO3?.lang?.["button.ok"]||"OK",btnClass:"btn-"+T.getCssClass(s),name:"ok"});const c=this.advanced({title:t,content:e,severity:s,buttons:a,additionalCssClasses:o});return c.addEventListener("button.clicked",m=>{const r=m.target;r.getAttribute("name")==="cancel"?r.dispatchEvent(new CustomEvent("confirm.button.cancel",{bubbles:!0})):r.getAttribute("name")==="ok"&&r.dispatchEvent(new CustomEvent("confirm.button.ok",{bubbles:!0}))}),c}loadUrl(t,e=f.info,s,a,o){return this.advanced({type:i.ajax,title:t,severity:e,buttons:s,ajaxCallback:o,content:a})}show(t,e,s=f.info,a,o){return this.advanced({type:i.default,title:t,content:e,severity:s,buttons:a,additionalCssClasses:o})}advanced(t){return t.type=typeof t.type=="string"&&t.type in i?t.type:this.defaultConfiguration.type,t.title=typeof t.title=="string"?t.title:this.defaultConfiguration.title,t.content=typeof t.content=="string"||typeof t.content=="object"?t.content:this.defaultConfiguration.content,t.severity=typeof t.severity<"u"?t.severity:this.defaultConfiguration.severity,t.buttons=t.buttons||this.defaultConfiguration.buttons,t.size=typeof t.size=="string"&&t.size in p?t.size:this.defaultConfiguration.size,t.style=typeof t.style=="string"&&t.style in b?t.style:this.defaultConfiguration.style,t.additionalCssClasses=t.additionalCssClasses||this.defaultConfiguration.additionalCssClasses,t.callback=typeof t.callback=="function"?t.callback:this.defaultConfiguration.callback,t.ajaxCallback=typeof t.ajaxCallback=="function"?t.ajaxCallback:this.defaultConfiguration.ajaxCallback,t.hideCloseButton=t.hideCloseButton||this.defaultConfiguration.hideCloseButton,t.staticBackdrop=t.staticBackdrop||this.defaultConfiguration.staticBackdrop,this.generate(t)}setButtons(t){return this.currentModal.buttons=t,this.currentModal}initializeMarkupTrigger(t){const e=(s,a)=>{s.preventDefault(),"bsContent"in a.dataset&&!("content"in a.dataset)&&console.error("TYPO3 v14 modal trigger dropped support for the legacy `data-bs-content` attribute. Use `data-content` instead. Affected element:",a);const o=a.dataset.content||TYPO3?.lang?.["message.confirmation"]||"Are you sure?";let c=f.notice;if(a.dataset.severity in f){const y=a.dataset.severity;c=f[y]}let m=p.default;if(a.dataset.size in p){const y=a.dataset.size;m=p[y]}let r=a.dataset.url||null;if(r!==null){const y=r.includes("?")?"&":"?",C=new URLSearchParams(a.dataset).toString();r=r+y+C}this.advanced({type:r!==null?i.ajax:i.default,title:a.dataset.title||"Alert",content:r!==null?r:o,size:m,severity:c,buttons:[{text:a.dataset.buttonCloseText||TYPO3?.lang?.["button.close"]||"Close",active:!0,btnClass:"btn-default",trigger:(y,C)=>{C.hideModal();const k=w.createModalResponseEventFromElement(a,!1);k!==null&&a.dispatchEvent(k)}},{text:a.dataset.buttonOkText||TYPO3?.lang?.["button.ok"]||"OK",btnClass:"btn-"+T.getCssClass(c),trigger:(y,C)=>{C.hideModal();const k=w.createModalResponseEventFromElement(a,!0);k!==null&&a.dispatchEvent(k);const j=a.dataset.uri||a.dataset.href||a.getAttribute("href");if(j&&j!=="#"&&(a.ownerDocument.location.href=j),a.getAttribute("type")==="submit"&&(a.tagName==="BUTTON"||a.tagName==="INPUT")){const B=a;B.form?.requestSubmit(B)}a.dataset.targetForm&&a.ownerDocument.querySelector("form#"+a.dataset.targetForm)?.submit()}}]})};new A("click",e).delegateTo(t,".t3js-modal-trigger")}generate(t){const e=document.createElement("typo3-backend-modal");return e.type=t.type,typeof t.content=="string"?e.content=t.content:t.type===i.default&&(e.type=i.template,e.templateResultContent=t.content),e.severity=t.severity,e.variant=t.style,e.size=t.size,e.modalTitle=t.title,e.additionalCssClasses=t.additionalCssClasses,e.buttons=t.buttons,e.hideCloseButton=t.hideCloseButton,e.staticBackdrop=t.staticBackdrop,t.callback&&(e.callback=t.callback),t.ajaxCallback&&(e.ajaxCallback=t.ajaxCallback),e.addEventListener("typo3-modal-shown",()=>{const s=e.querySelector(`${M.footer} .t3js-active`);s!==null&&s.focus()}),e.addEventListener("typo3-modal-hide",()=>{if(this.instances.length>0){const s=this.instances.length-1;this.instances.splice(s,1),this.currentModal=this.instances[s-1]}}),e.addEventListener("typo3-modal-hidden",()=>{e.remove()}),e.addEventListener("typo3-modal-show",()=>{this.currentModal=e,this.instances.push(e)}),document.body.appendChild(e),e}}let v=null;try{parent&&parent.window.TYPO3&&parent.window.TYPO3.Modal?(parent.window.TYPO3.Modal.initializeMarkupTrigger(document),v=parent.window.TYPO3.Modal):top&&top.TYPO3.Modal&&(top.TYPO3.Modal.initializeMarkupTrigger(document),v=top.TYPO3.Modal)}catch{}v||(v=new w,typeof TYPO3<"u"&&(TYPO3.Modal=v));var E=v;export{M as Identifiers,n as ModalElement,p as Sizes,b as Styles,i as Types,E as default};
