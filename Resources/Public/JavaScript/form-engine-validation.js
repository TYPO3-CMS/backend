/*
 * This file is part of the TYPO3 CMS project.
 *
 * It is free software; you can redistribute it and/or modify it under
 * the terms of the GNU General Public License, either version 2
 * of the License, or any later version.
 *
 * For the full copyright and license information, please read the
 * LICENSE.txt file that was distributed with this source code.
 *
 * The TYPO3 project - inspiring people to share!
 */
import{DateTime as p}from"luxon";import g from"@typo3/backend/hashing/md5.js";import y from"@typo3/backend/modal.js";import v from"@typo3/backend/severity.js";import I from"@typo3/backend/utility.js";import k from"@typo3/core/event/regular-event.js";import w from"@typo3/backend/utility/dom-helper.js";import{selector as d}from"@typo3/core/literals.js";import N from"@typo3/backend/form/submit-interceptor.js";import{FormEngineReview as E}from"@typo3/backend/form-engine-review.js";let o,S=!1;const h=new Map;class r{static{this.rulesSelector="[data-formengine-validation-rules]"}static{this.inputSelector="[data-formengine-input-params]"}static{this.markerSelector=".t3js-formengine-validation-marker"}static{this.labelSelector=".t3js-formengine-label"}static{this.errorClass="has-error"}static{this.validationErrorClass="has-validation-error"}static{this.passwordDummy="********"}static initialize(t){o=t,o.formElement.querySelectorAll("."+r.errorClass).forEach(e=>e.classList.remove(r.errorClass)),r.initializeInputFields(),new E(o.formElement),new k("change",(e,s)=>{r.validateField(s),o.markFieldAsChanged(s)}).delegateTo(o.formElement,r.rulesSelector),r.registerSubmitCallback(),r.validate()}static initializeInputFields(){o.formElement.querySelectorAll(r.inputSelector).forEach(t=>{if("formengineInputInitialized"in t.dataset)return;const s=JSON.parse(t.dataset.formengineInputParams).field,a=o.formElement.querySelector(d`[name="${s}"]`);a.dataset.config=t.dataset.formengineInputParams,r.initializeInputField(s)})}static initializeInputField(t){const e=o.formElement.querySelector(d`[name="${t}"]`),s=o.formElement.querySelector(d`[data-formengine-input-name="${t}"]`);if(e.dataset.config!==void 0){const a=JSON.parse(e.dataset.config),i=r.formatByEvals(a,e.value);i.length&&(s.value=i)}new k("change",()=>{r.updateInputField(s.dataset.formengineInputName)}).bindTo(s),s.dataset.formengineInputInitialized="true"}static registerCustomEvaluation(t,e){h.has(t)||h.set(t,e)}static formatByEvals(t,e){if(t.evalList!==void 0){const s=I.trimExplode(",",t.evalList);for(const a of s)e=r.formatValue(a,e)}return e}static formatValue(t,e){switch(t){case"date":case"datetime":case"time":case"timesec":if(e==="")return"";const s=p.fromISO(String(e));if(!s.isValid)throw new Error("Invalid ISO8601 DateTime string: "+e);return s.toISO({suppressMilliseconds:!0,includeOffset:!1});case"password":return e?r.passwordDummy:"";default:return e.toString()}}static updateInputField(t){const e=o.formElement.querySelector(d`[name="${t}"]`),s=o.formElement.querySelector(d`[data-formengine-input-name="${t}"]`);if(e.dataset.config!==void 0){const a=JSON.parse(e.dataset.config),i=r.processByEvals(a,s.value),m=r.formatByEvals(a,i);e.value!==i&&(e.disabled&&e.dataset.enableOnModification&&(e.disabled=!1),e.value=i,e.dispatchEvent(new Event("change"))),s.value!==m&&(s.value=m)}}static validateField(t){if(t.dataset.formengineValidationRules===void 0)return;let e=t.value||"";const s=JSON.parse(t.dataset.formengineValidationRules);let a=!1,i=0,m,n,c;Array.isArray(e)||(e=e.trimStart());for(const l of s){if(a)break;switch(l.type){case"required":e===""&&(a=!0,t.classList.add(r.errorClass),t.closest(r.markerSelector)?.querySelector(r.labelSelector)?.classList.add(r.errorClass));break;case"range":if(e!==""){if((l.minItems||l.maxItems)&&(m=o.formElement.querySelector(d`[name="${t.dataset.relatedfieldname}"]`),m!==null?i=I.trimExplode(",",m.value).length:i=parseInt(t.value,10),l.minItems!==void 0&&(n=l.minItems*1,!isNaN(n)&&i<n&&(a=!0)),l.maxItems!==void 0&&(c=l.maxItems*1,!isNaN(c)&&i>c&&(a=!0))),l.lower!==void 0)if(t.dataset.inputType==="datetimepicker"){const u=p.fromISO(e,{zone:"utc"}),b=p.fromISO(l.lower,{zone:"utc"});(!u.isValid||u<b.minus(b.second*1e3))&&(a=!0)}else{const u=l.lower*1;!isNaN(u)&&parseInt(e,10)<u&&(a=!0)}if(l.upper!==void 0)if(t.dataset.inputType==="datetimepicker"){const u=p.fromISO(e,{zone:"utc"}),b=p.fromISO(l.upper,{zone:"utc"});(!u.isValid||u>b.plus((59-b.second)*1e3))&&(a=!0)}else{const u=l.upper*1;!isNaN(u)&&parseInt(e,10)>u&&(a=!0)}}break;case"select":case"category":(l.minItems||l.maxItems)&&(m=o.formElement.querySelector(d`[name="${t.dataset.relatedfieldname}"]`),m!==null?i=I.trimExplode(",",m.value).length:t instanceof HTMLSelectElement?i=t.querySelectorAll("option:checked").length:i=t.querySelectorAll("input[value]:checked").length,l.minItems!==void 0&&(n=l.minItems*1,!isNaN(n)&&i<n&&(a=!0)),l.maxItems!==void 0&&(c=l.maxItems*1,!isNaN(c)&&i>c&&(a=!0)));break;case"group":case"folder":(l.minItems||l.maxItems)&&(i=I.trimExplode(",",t.value).length,l.minItems!==void 0&&(n=l.minItems*1,!isNaN(n)&&i<n&&(a=!0)),l.maxItems!==void 0&&(c=l.maxItems*1,!isNaN(c)&&i>c&&(a=!0)));break;case"inline":(l.minItems||l.maxItems)&&(i=I.trimExplode(",",t.value).length,l.minItems!==void 0&&(n=l.minItems*1,!isNaN(n)&&i<n&&(a=!0)),l.maxItems!==void 0&&(c=l.maxItems*1,!isNaN(c)&&i>c&&(a=!0)));break;case"min":(t instanceof HTMLInputElement||t instanceof HTMLTextAreaElement)&&t.value.length>0&&t.value.length<t.minLength&&(a=!0);break;case"null":break;default:break}}const f=!a;t.classList.toggle(r.errorClass,!f),t.closest(r.markerSelector)?.querySelector(r.labelSelector)?.classList.toggle(r.errorClass,!f),r.markParentTab(t,f),o.formElement.dispatchEvent(new CustomEvent("t3-formengine-postfieldvalidation",{detail:{field:t,isValid:f},cancelable:!1,bubbles:!0}))}static processByEvals(t,e){if(t.evalList!==void 0){const s=I.trimExplode(",",t.evalList);for(const a of s)e=r.processValue(a,e,t)}return e}static processValue(t,e,s){let a="",i="",m=0,n=e;switch(t){case"alpha":case"num":case"alphanum":case"alphanum_x":for(a="",m=0;m<e.length;m++){const c=e.substr(m,1);let f=c==="_"||c==="-",l=c>="a"&&c<="z"||c>="A"&&c<="Z",u=c>="0"&&c<="9";switch(t){case"alphanum":f=!1;break;case"alpha":u=!1,f=!1;break;case"num":l=!1,f=!1;break;default:break}(l||u||f)&&(a+=c)}a!==e&&(n=a);break;case"is_in":if(s.is_in){i=""+e,s.is_in=s.is_in.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&");const c=new RegExp("[^"+s.is_in+"]+","g");a=i.replace(c,"")}else a=i;n=a;break;case"nospace":n=(""+e).replace(/ /g,"");break;case"md5":e!==""&&(n=g.hash(e));break;case"upper":n=e.toUpperCase();break;case"lower":n=e.toLowerCase();break;case"integer":e!==""&&(n=r.parseInt(e).toString());break;case"decimal":e!==""&&(n=r.parseDouble(e));break;case"trim":n=String(e).trim();break;case"time":case"timesec":e!==""&&(n=p.fromISO(e).set({year:1970,month:1,day:1}).toISO({suppressMilliseconds:!0,includeOffset:!1}));break;case"year":if(e!==""){let c=parseInt(e,10);isNaN(c)&&(c=new Date().getUTCFullYear()),n=c.toString(10)}break;case"null":break;case"password":break;default:h.has(t)?n=h.get(t).call(null,e):typeof TBE_EDITOR=="object"&&TBE_EDITOR.customEvalFunctions!==void 0&&typeof TBE_EDITOR.customEvalFunctions[t]=="function"&&(n=TBE_EDITOR.customEvalFunctions[t](e))}return n}static validate(t){(typeof t>"u"||t instanceof Document)&&o.formElement.querySelectorAll(r.markerSelector+", .t3js-tabmenu-item").forEach(s=>{s.classList.remove(r.validationErrorClass)});const e=t||document;for(const s of e.querySelectorAll(r.rulesSelector))s.closest(".t3js-flex-section-deleted, .t3js-inline-record-deleted, .t3js-file-reference-deleted")===null&&r.validateField(s)}static markFieldAsChanged(t){console.warn("Calling markFieldAsChanged() from '@typo3/backend/form-engine-validation' is deprecated and will be removed in TYPO3 v15. Instead, call the method from '@typo3/backend/form-engine'."),o.markFieldAsChanged(t)}static parseInt(t){const e=""+t;if(!t)return 0;const s=parseInt(e,10);return isNaN(s)?0:s}static parseDouble(t,e=2){let s=""+t;s=s.replace(/[^0-9,.-]/g,"");const a=s.startsWith("-");s=s.replace(/-/g,""),s=s.replace(/,/g,"."),s.indexOf(".")===-1&&(s+=".0");const i=s.split("."),m=i.pop();let n=+(i.join("")+"."+m);return a&&(n*=-1),s=n.toFixed(e),s}static markParentTab(t,e){w.parents(t,".tab-pane").forEach(a=>{e&&(e=a.querySelector(".has-error")===null);const i=a.id;o.formElement.querySelector('[data-bs-target="#'+i+'"]').closest(".t3js-tabmenu-item").classList.toggle(r.validationErrorClass,!e)})}static suspend(){S=!0}static resume(){S=!1}static isValid(){return document.querySelector("."+r.errorClass)===null}static showErrorModal(){const t=y.confirm(TYPO3.lang.alert||"Alert",TYPO3.lang["FormEngine.fieldsMissing"],v.error,[{text:TYPO3.lang["button.ok"]||"OK",active:!0,btnClass:"btn-default",name:"ok"}]);t.addEventListener("button.clicked",()=>t.hideModal())}static registerSubmitCallback(){new N(o.formElement).addPreSubmitCallback(()=>S||r.isValid()?!0:(r.showErrorModal(),!1))}}export{r as default};
