/*
 * This file is part of the TYPO3 CMS project.
 *
 * It is free software; you can redistribute it and/or modify it under
 * the terms of the GNU General Public License, either version 2
 * of the License, or any later version.
 *
 * For the full copyright and license information, please read the
 * LICENSE.txt file that was distributed with this source code.
 *
 * The TYPO3 project - inspiring people to share!
 */
var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,r,s){void 0===s&&(s=r),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[r]}})}:function(e,t,r,s){void 0===s&&(s=r),e[s]=t[r]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&__createBinding(t,e,r);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};define(["require","exports","jquery","d3-drag","d3-selection"],(function(e,t,r,s,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PageTreeDragDrop=void 0,r=__importDefault(r),s=__importStar(s),o=__importStar(o);class d{constructor(e){this.timeout={},this.tree=e}static setDragStart(){r.default("body iframe").css({"pointer-events":"none"})}static setDragEnd(){r.default("body iframe").css({"pointer-events":""})}connectDragHandler(e){return s.drag().clickDistance(5).on("start",(function(t){e.dragStart(t)&&d.setDragStart()})).on("drag",(function(t){e.dragDragged(t)})).on("end",(function(t){d.setDragEnd(),e.dragEnd(t)}))}openNodeTimeout(){null!==this.tree.hoveredNode&&this.tree.hoveredNode.hasChildren&&!this.tree.hoveredNode.expanded?this.timeout.node!=this.tree.hoveredNode&&(this.timeout.node=this.tree.hoveredNode,clearTimeout(this.timeout.time),this.timeout.time=setTimeout(()=>{this.tree.hoveredNode&&(this.tree.showChildren(this.tree.hoveredNode),this.tree.prepareDataForVisibleNodes(),this.tree.update())},1e3)):clearTimeout(this.timeout.time)}changeNodeClasses(e){const t=this.tree.svg.select(".node-over"),s=r.default(this.tree.svg.node()),d=s.find(".nodes-wrapper"),i=s.siblings(".node-dd");let n=this.tree.nodesBgContainer.selectAll(".node-bg__border");if(t.size()&&this.tree.isOverSvg){n.empty()&&(n=this.tree.nodesBgContainer.append("rect").attr("class","node-bg__border").attr("height","1px").attr("width","100%"));let r=o.pointer(e,t.node())[1];r<3?(n.attr("transform","translate(-8, "+(this.tree.hoveredNode.y-10)+")").style("display","block"),0===this.tree.hoveredNode.depth?this.addNodeDdClass(d,i,"nodrop"):this.tree.hoveredNode.firstChild?this.addNodeDdClass(d,i,"ok-above"):this.addNodeDdClass(d,i,"ok-between"),this.tree.settings.nodeDragPosition="before"):r>17?(n.style("display","none"),this.tree.hoveredNode.expanded&&this.tree.hoveredNode.hasChildren?(this.addNodeDdClass(d,i,"ok-append"),this.tree.settings.nodeDragPosition="in"):(n.attr("transform","translate(-8, "+(this.tree.hoveredNode.y+10)+")").style("display","block"),this.tree.hoveredNode.lastChild?this.addNodeDdClass(d,i,"ok-below"):this.addNodeDdClass(d,i,"ok-between"),this.tree.settings.nodeDragPosition="after")):(n.style("display","none"),this.addNodeDdClass(d,i,"ok-append"),this.tree.settings.nodeDragPosition="in")}else this.tree.nodesBgContainer.selectAll(".node-bg__border").style("display","none"),this.addNodeDdClass(d,i,"nodrop")}addNodeDdClass(e,t,r="",s=!1){const o=" #prefix#--nodrop #prefix#--ok-append #prefix#--ok-below #prefix#--ok-between #prefix#--ok-above";let d="",i="",n={rmClass:""};!0===s&&(n={rmClass:"dragging",setCanNodeDrag:!1}),t&&(d=n.rmClass?" node-dd--"+n.rmClass:"",i=r?"node-dd--"+r:"",t.removeClass(o.replace(new RegExp("#prefix#","g"),"node-dd")+d).addClass(i)),e&&(d=n.rmClass?" nodes-wrapper--"+n.rmClass:"",i=r?"nodes-wrapper--"+r:"",e.removeClass(o.replace(new RegExp("#prefix#","g"),"nodes-wrapper")+d).addClass(i)),(void 0===n.setCanNodeDrag||n.setCanNodeDrag)&&(this.tree.settings.canNodeDrag=!("nodrop"===r))}isDragNodeDistanceMore(e,t){return t.startDrag||t.startPageX-10>e.sourceEvent.pageX||t.startPageX+10<e.sourceEvent.pageX||t.startPageY-10>e.sourceEvent.pageY||t.startPageY+10<e.sourceEvent.pageY}changeNodePosition(e,t=""){const r=this.tree.nodes,s=this.tree.settings.nodeDrag.identifier,o=r.indexOf(e);let d=this.tree.settings.nodeDragPosition,i=e||this.tree.settings.nodeDrag;if(s!==i.identifier||"delete"===t){if("before"===d){const e=this.setNodePositionAndTarget(o);d=e[0],i=e[1]}return{node:this.tree.settings.nodeDrag,uid:s,target:i,position:d,command:t}}}setNodePositionAndTarget(e){const t=this.tree.nodes,r=t[e].depth;e>0&&e--;const s=t[e].depth,o=this.tree.nodes[e];if(s===r)return["after",o];if(s<r)return["in",o];for(let s=e;s>=0;s--){if(t[s].depth===r)return["after",this.tree.nodes[s]];if(t[s].depth<r)return["in",t[s]]}}}t.PageTreeDragDrop=d}));