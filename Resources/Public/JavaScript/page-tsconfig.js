/*
 * This file is part of the TYPO3 CMS project.
 *
 * It is free software; you can redistribute it and/or modify it under
 * the terms of the GNU General Public License, either version 2
 * of the License, or any later version.
 *
 * For the full copyright and license information, please read the
 * LICENSE.txt file that was distributed with this source code.
 *
 * The TYPO3 project - inspiring people to share!
 */
import BrowserSession from"@typo3/backend/storage/browser-session.js";import{Collapse as BootstrapCollapse}from"bootstrap";import"@typo3/backend/input/clearable.js";import DocumentService from"@typo3/core/document-service.js";import DebounceEvent from"@typo3/core/event/debounce-event.js";import RegularEvent from"@typo3/core/event/regular-event.js";import Mark from"@typo3/backend/contrib/mark.js";class PageTSconfigBrowser{constructor(){this.termSessionStorageKey="pagets-search-term",DocumentService.ready().then((()=>{if(this.pageTsTreeContainer=document.querySelector(".t3js-pagets-tree"),null===this.pageTsTreeContainer)return;this.searchField=document.querySelector('input[name="searchValue"]'),this.searchForm=this.searchField.closest("form"),this.registerEvents(),this.markInstance=new Mark(this.pageTsTreeContainer);const e=BrowserSession.get(this.termSessionStorageKey);e&&(this.searchField.value=e,this.searchField.dispatchEvent(new Event("keyup")),this.searchForm.requestSubmit())}))}registerEvents(){this.searchField.clearable({onClear:e=>{e.closest("form").requestSubmit()}}),new DebounceEvent("input",(()=>{this.searchForm.requestSubmit()})).bindTo(this.searchField),new RegularEvent("submit",(e=>{e.preventDefault(),this.filterTree(this.searchField.value)})).bindTo(this.searchForm)}filterTree(e){if(e=e.toLowerCase(),this.markInstance.unmark(),BrowserSession.set(this.termSessionStorageKey,e),e.length<3)return;const t=new Set;[...this.findNodesByIdentifier(e),...this.findNodesByValue(e)].forEach((e=>{if(null===e)return;const r=e.parentElement.querySelector('[data-bs-toggle="collapse"]')?.dataset.bsTarget;void 0!==r&&t.add(r.substring(1));const s=this.parents(e,".collapse");for(let e of s)t.add(e.id)}));const r=Array.from(this.pageTsTreeContainer.querySelectorAll(".collapse"));for(let e of r){const r=BootstrapCollapse.getOrCreateInstance(e,{toggle:!1});t.has(e.id)?r.show():r.hide()}this.markInstance.mark(e,{element:"strong",className:"text-danger"})}findNodesByIdentifier(e){const t=[],r=this.pageTsTreeContainer.querySelectorAll('[data-pagets-identifier="'+e+'"]');if(t.push(...r),0===r.length){const r=Array.from(this.pageTsTreeContainer.querySelectorAll('[data-pagets-identifier*="'+e+'"]')).filter((t=>{const r=t.dataset.pagetsIdentifier.indexOf(e)+e.length;return!t.dataset.pagetsIdentifier.substring(r).includes(".")}));t.push(...r)}return t}findNodesByValue(e){return Array.from(this.pageTsTreeContainer.querySelectorAll(".list-tree-value")).filter((t=>t.textContent.toLowerCase().includes(e))).map((e=>e.previousElementSibling))}parents(e,t){const r=[];let s;for(;null!==(s=e.parentElement.closest(t));)e=s,r.push(s);return r}}export default new PageTSconfigBrowser;