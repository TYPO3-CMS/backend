/*
 * This file is part of the TYPO3 CMS project.
 *
 * It is free software; you can redistribute it and/or modify it under
 * the terms of the GNU General Public License, either version 2
 * of the License, or any later version.
 *
 * For the full copyright and license information, please read the
 * LICENSE.txt file that was distributed with this source code.
 *
 * The TYPO3 project - inspiring people to share!
 */
var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,s,r){void 0===r&&(r=s),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[s]}})}:function(e,t,s,r){void 0===r&&(r=s),e[r]=t[s]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&__createBinding(t,e,s);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};define(["require","exports","jquery","d3-drag","d3-selection"],(function(e,t,s,r,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PageTreeDragDrop=void 0,s=__importDefault(s),r=__importStar(r),n=__importStar(n);class o{constructor(e){this.timeout={},this.tree=e}static setDragStart(){s.default("body iframe").css({"pointer-events":"none"})}static setDragEnd(){s.default("body iframe").css({"pointer-events":""})}connectDragHandler(e){return r.drag().clickDistance(5).on("start",(function(t){e.dragStart(t)&&o.setDragStart()})).on("drag",(function(t){e.dragDragged(t)})).on("end",(function(t){o.setDragEnd(),e.dragEnd(t)}))}openNodeTimeout(){this.tree.settings.nodeOver.node&&this.tree.settings.nodeOver.node.hasChildren&&!this.tree.settings.nodeOver.node.expanded?this.timeout.node!=this.tree.settings.nodeOver.node&&(this.timeout.node=this.tree.settings.nodeOver,clearTimeout(this.timeout.time),this.timeout.time=setTimeout(()=>{this.tree.settings.nodeOver.node&&(this.tree.showChildren(this.tree.settings.nodeOver.node),this.tree.prepareDataForVisibleNodes(),this.tree.update())},1e3)):clearTimeout(this.timeout.time)}changeNodeClasses(e){const t=this.tree.svg.select(".node-over"),r=s.default(this.tree.svg.node()),o=r.find(".nodes-wrapper"),i=r.siblings(".node-dd");let d=this.tree.nodesBgContainer.selectAll(".node-bg__border");if(t.size()&&this.tree.isOverSvg){d.empty()&&(d=this.tree.nodesBgContainer.append("rect").attr("class","node-bg__border").attr("height","1px").attr("width","100%"));let s=n.pointer(e,t.node())[1];s<3?(d.attr("transform","translate(-8, "+(this.tree.settings.nodeOver.node.y-10)+")").style("display","block"),0===this.tree.settings.nodeOver.node.depth?this.addNodeDdClass(o,i,"nodrop"):this.tree.settings.nodeOver.node.firstChild?this.addNodeDdClass(o,i,"ok-above"):this.addNodeDdClass(o,i,"ok-between"),this.tree.settings.nodeDragPosition="before"):s>17?(d.style("display","none"),this.tree.settings.nodeOver.node.expanded&&this.tree.settings.nodeOver.node.hasChildren?(this.addNodeDdClass(o,i,"ok-append"),this.tree.settings.nodeDragPosition="in"):(d.attr("transform","translate(-8, "+(this.tree.settings.nodeOver.node.y+10)+")").style("display","block"),this.tree.settings.nodeOver.node.lastChild?this.addNodeDdClass(o,i,"ok-below"):this.addNodeDdClass(o,i,"ok-between"),this.tree.settings.nodeDragPosition="after")):(d.style("display","none"),this.addNodeDdClass(o,i,"ok-append"),this.tree.settings.nodeDragPosition="in")}else this.tree.nodesBgContainer.selectAll(".node-bg__border").style("display","none"),this.addNodeDdClass(o,i,"nodrop")}addNodeDdClass(e,t,s="",r=!1){const n=" #prefix#--nodrop #prefix#--ok-append #prefix#--ok-below #prefix#--ok-between #prefix#--ok-above";let o="",i="",d={rmClass:""};!0===r&&(d={rmClass:"dragging",setCanNodeDrag:!1}),t&&(o=d.rmClass?" node-dd--"+d.rmClass:"",i=s?"node-dd--"+s:"",t.removeClass(n.replace(new RegExp("#prefix#","g"),"node-dd")+o).addClass(i)),e&&(o=d.rmClass?" nodes-wrapper--"+d.rmClass:"",i=s?"nodes-wrapper--"+s:"",e.removeClass(n.replace(new RegExp("#prefix#","g"),"nodes-wrapper")+o).addClass(i)),(void 0===d.setCanNodeDrag||d.setCanNodeDrag)&&(this.tree.settings.canNodeDrag=!("nodrop"===s))}isDragNodeDistanceMore(e,t){return t.startDrag||t.startPageX-10>e.sourceEvent.pageX||t.startPageX+10<e.sourceEvent.pageX||t.startPageY-10>e.sourceEvent.pageY||t.startPageY+10<e.sourceEvent.pageY}changeNodePosition(e,t=""){const s=this.tree.nodes,r=this.tree.settings.nodeDrag.identifier,n=s.indexOf(e);let o=this.tree.settings.nodeDragPosition,i=e||this.tree.settings.nodeDrag;if(r!==i.identifier||"delete"===t){if("before"===o){const e=this.setNodePositionAndTarget(n);o=e[0],i=e[1]}return{node:this.tree.settings.nodeDrag,uid:r,target:i,position:o,command:t}}}setNodePositionAndTarget(e){const t=this.tree.nodes,s=t[e].depth;e>0&&e--;const r=t[e].depth,n=this.tree.nodes[e];if(r===s)return["after",n];if(r<s)return["in",n];for(let r=e;r>=0;r--){if(t[r].depth===s)return["after",this.tree.nodes[r]];if(t[r].depth<s)return["in",t[r]]}}}t.PageTreeDragDrop=o}));