/*
 * This file is part of the TYPO3 CMS project.
 *
 * It is free software; you can redistribute it and/or modify it under
 * the terms of the GNU General Public License, either version 2
 * of the License, or any later version.
 *
 * For the full copyright and license information, please read the
 * LICENSE.txt file that was distributed with this source code.
 *
 * The TYPO3 project - inspiring people to share!
 */
import{DateTime as p}from"luxon";import g from"@typo3/backend/hashing/md5.js";import y from"@typo3/backend/modal.js";import v from"@typo3/backend/severity.js";import I from"@typo3/backend/utility.js";import k from"@typo3/core/event/regular-event.js";import w from"@typo3/backend/utility/dom-helper.js";import{selector as d}from"@typo3/core/literals.js";import N from"@typo3/backend/form/submit-interceptor.js";import{FormEngineReview as x}from"@typo3/backend/form-engine-review.js";let u,S=!1;const b=new Map;class r{static{this.rulesSelector="[data-formengine-validation-rules]"}static{this.inputSelector="[data-formengine-input-params]"}static{this.markerSelector=".t3js-formengine-validation-marker"}static{this.labelSelector=".t3js-formengine-label"}static{this.errorClass="has-error"}static{this.validationErrorClass="has-validation-error"}static{this.passwordDummy="********"}static initialize(t){u=t,u.formElement.querySelectorAll("."+r.errorClass).forEach(e=>e.classList.remove(r.errorClass)),r.initializeInputFields(),new x(u.formElement),new k("change",(e,s)=>{r.validateField(s),r.markFieldAsChanged(s)}).delegateTo(u.formElement,r.rulesSelector),r.registerSubmitCallback(),r.validate()}static initializeInputFields(){u.formElement.querySelectorAll(r.inputSelector).forEach(t=>{const s=JSON.parse(t.dataset.formengineInputParams).field,a=u.formElement.querySelector(d`[name="${s}"]`);"formengineInputInitialized"in t.dataset||(a.dataset.config=t.dataset.formengineInputParams,r.initializeInputField(s))})}static initializeInputField(t){const e=u.formElement.querySelector(d`[name="${t}"]`),s=u.formElement.querySelector(d`[data-formengine-input-name="${t}"]`);if(e.dataset.config!==void 0){const a=JSON.parse(e.dataset.config),i=r.formatByEvals(a,e.value);i.length&&(s.value=i)}new k("change",()=>{r.updateInputField(s.dataset.formengineInputName)}).bindTo(s),s.dataset.formengineInputInitialized="true"}static registerCustomEvaluation(t,e){b.has(t)||b.set(t,e)}static formatByEvals(t,e){if(t.evalList!==void 0){const s=I.trimExplode(",",t.evalList);for(const a of s)e=r.formatValue(a,e)}return e}static formatValue(t,e){switch(t){case"date":case"datetime":case"time":case"timesec":if(e==="")return"";const s=p.fromISO(String(e));if(!s.isValid)throw new Error("Invalid ISO8601 DateTime string: "+e);return s.toISO({suppressMilliseconds:!0,includeOffset:!1});case"password":return e?r.passwordDummy:"";default:return e.toString()}}static updateInputField(t){const e=u.formElement.querySelector(d`[name="${t}"]`),s=u.formElement.querySelector(d`[data-formengine-input-name="${t}"]`);if(e.dataset.config!==void 0){const a=JSON.parse(e.dataset.config),i=r.processByEvals(a,s.value),o=r.formatByEvals(a,i);e.value!==i&&(e.disabled&&e.dataset.enableOnModification&&(e.disabled=!1),e.value=i,e.dispatchEvent(new Event("change"))),s.value!==o&&(s.value=o)}}static validateField(t){if(t.dataset.formengineValidationRules===void 0)return;let e=t.value||"";const s=JSON.parse(t.dataset.formengineValidationRules);let a=!1,i=0,o,n,c;Array.isArray(e)||(e=e.trimStart());for(const l of s){if(a)break;switch(l.type){case"required":e===""&&(a=!0,t.classList.add(r.errorClass),t.closest(r.markerSelector)?.querySelector(r.labelSelector)?.classList.add(r.errorClass));break;case"range":if(e!==""){if((l.minItems||l.maxItems)&&(o=u.formElement.querySelector(d`[name="${t.dataset.relatedfieldname}"]`),o!==null?i=I.trimExplode(",",o.value).length:i=parseInt(t.value,10),l.minItems!==void 0&&(n=l.minItems*1,!isNaN(n)&&i<n&&(a=!0)),l.maxItems!==void 0&&(c=l.maxItems*1,!isNaN(c)&&i>c&&(a=!0))),l.lower!==void 0)if(t.dataset.inputType==="datetimepicker"){const f=p.fromISO(e,{zone:"utc"}),h=p.fromISO(l.lower,{zone:"utc"});(!f.isValid||f<h.minus(h.second*1e3))&&(a=!0)}else{const f=l.lower*1;!isNaN(f)&&parseInt(e,10)<f&&(a=!0)}if(l.upper!==void 0)if(t.dataset.inputType==="datetimepicker"){const f=p.fromISO(e,{zone:"utc"}),h=p.fromISO(l.upper,{zone:"utc"});(!f.isValid||f>h.plus((59-h.second)*1e3))&&(a=!0)}else{const f=l.upper*1;!isNaN(f)&&parseInt(e,10)>f&&(a=!0)}}break;case"select":case"category":(l.minItems||l.maxItems)&&(o=u.formElement.querySelector(d`[name="${t.dataset.relatedfieldname}"]`),o!==null?i=I.trimExplode(",",o.value).length:t instanceof HTMLSelectElement?i=t.querySelectorAll("option:checked").length:i=t.querySelectorAll("input[value]:checked").length,l.minItems!==void 0&&(n=l.minItems*1,!isNaN(n)&&i<n&&(a=!0)),l.maxItems!==void 0&&(c=l.maxItems*1,!isNaN(c)&&i>c&&(a=!0)));break;case"group":case"folder":(l.minItems||l.maxItems)&&(i=I.trimExplode(",",t.value).length,l.minItems!==void 0&&(n=l.minItems*1,!isNaN(n)&&i<n&&(a=!0)),l.maxItems!==void 0&&(c=l.maxItems*1,!isNaN(c)&&i>c&&(a=!0)));break;case"inline":(l.minItems||l.maxItems)&&(i=I.trimExplode(",",t.value).length,l.minItems!==void 0&&(n=l.minItems*1,!isNaN(n)&&i<n&&(a=!0)),l.maxItems!==void 0&&(c=l.maxItems*1,!isNaN(c)&&i>c&&(a=!0)));break;case"min":(t instanceof HTMLInputElement||t instanceof HTMLTextAreaElement)&&t.value.length>0&&t.value.length<t.minLength&&(a=!0);break;case"null":break;default:break}}const m=!a;t.classList.toggle(r.errorClass,!m),t.closest(r.markerSelector)?.querySelector(r.labelSelector)?.classList.toggle(r.errorClass,!m),r.markParentTab(t,m),u.formElement.dispatchEvent(new CustomEvent("t3-formengine-postfieldvalidation",{detail:{field:t,isValid:m},cancelable:!1,bubbles:!0}))}static processByEvals(t,e){if(t.evalList!==void 0){const s=I.trimExplode(",",t.evalList);for(const a of s)e=r.processValue(a,e,t)}return e}static processValue(t,e,s){let a="",i="",o=0,n=e;switch(t){case"alpha":case"num":case"alphanum":case"alphanum_x":for(a="",o=0;o<e.length;o++){const c=e.substr(o,1);let m=c==="_"||c==="-",l=c>="a"&&c<="z"||c>="A"&&c<="Z",f=c>="0"&&c<="9";switch(t){case"alphanum":m=!1;break;case"alpha":f=!1,m=!1;break;case"num":l=!1,m=!1;break;default:break}(l||f||m)&&(a+=c)}a!==e&&(n=a);break;case"is_in":if(s.is_in){i=""+e,s.is_in=s.is_in.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&");const c=new RegExp("[^"+s.is_in+"]+","g");a=i.replace(c,"")}else a=i;n=a;break;case"nospace":n=(""+e).replace(/ /g,"");break;case"md5":e!==""&&(n=g.hash(e));break;case"upper":n=e.toUpperCase();break;case"lower":n=e.toLowerCase();break;case"integer":e!==""&&(n=r.parseInt(e).toString());break;case"decimal":e!==""&&(n=r.parseDouble(e));break;case"trim":n=String(e).trim();break;case"time":case"timesec":e!==""&&(n=p.fromISO(e).set({year:1970,month:1,day:1}).toISO({suppressMilliseconds:!0,includeOffset:!1}));break;case"year":if(e!==""){let c=parseInt(e,10);isNaN(c)&&(c=new Date().getUTCFullYear()),n=c.toString(10)}break;case"null":break;case"password":break;default:b.has(t)?n=b.get(t).call(null,e):typeof TBE_EDITOR=="object"&&TBE_EDITOR.customEvalFunctions!==void 0&&typeof TBE_EDITOR.customEvalFunctions[t]=="function"&&(n=TBE_EDITOR.customEvalFunctions[t](e))}return n}static validate(t){(typeof t>"u"||t instanceof Document)&&u.formElement.querySelectorAll(r.markerSelector+", .t3js-tabmenu-item").forEach(s=>{s.classList.remove(r.validationErrorClass)});const e=t||document;for(const s of e.querySelectorAll(r.rulesSelector))s.closest(".t3js-flex-section-deleted, .t3js-inline-record-deleted, .t3js-file-reference-deleted")===null&&r.validateField(s)}static markFieldAsChanged(t){t.classList.add("has-change");const e=t.closest(".t3js-formengine-palette-field")?.querySelector(".t3js-formengine-label");e!==null&&e.classList.add("has-change")}static parseInt(t){const e=""+t;if(!t)return 0;const s=parseInt(e,10);return isNaN(s)?0:s}static parseDouble(t,e=2){let s=""+t;s=s.replace(/[^0-9,.-]/g,"");const a=s.startsWith("-");s=s.replace(/-/g,""),s=s.replace(/,/g,"."),s.indexOf(".")===-1&&(s+=".0");const i=s.split("."),o=i.pop();let n=+(i.join("")+"."+o);return a&&(n*=-1),s=n.toFixed(e),s}static markParentTab(t,e){w.parents(t,".tab-pane").forEach(a=>{e&&(e=a.querySelector(".has-error")===null);const i=a.id;u.formElement.querySelector('[data-bs-target="#'+i+'"]').closest(".t3js-tabmenu-item").classList.toggle(r.validationErrorClass,!e)})}static suspend(){S=!0}static resume(){S=!1}static isValid(){return document.querySelector("."+r.errorClass)===null}static showErrorModal(){const t=y.confirm(TYPO3.lang.alert||"Alert",TYPO3.lang["FormEngine.fieldsMissing"],v.error,[{text:TYPO3.lang["button.ok"]||"OK",active:!0,btnClass:"btn-default",name:"ok"}]);t.addEventListener("button.clicked",()=>t.hideModal())}static registerSubmitCallback(){new N(u.formElement).addPreSubmitCallback(()=>S||r.isValid()?!0:(r.showErrorModal(),!1))}}export{r as default};
