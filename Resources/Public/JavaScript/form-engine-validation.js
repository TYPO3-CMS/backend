/*
 * This file is part of the TYPO3 CMS project.
 *
 * It is free software; you can redistribute it and/or modify it under
 * the terms of the GNU General Public License, either version 2
 * of the License, or any later version.
 *
 * For the full copyright and license information, please read the
 * LICENSE.txt file that was distributed with this source code.
 *
 * The TYPO3 project - inspiring people to share!
 */
import{DateTime}from"luxon";import Md5 from"@typo3/backend/hashing/md5.js";import Modal from"@typo3/backend/modal.js";import Severity from"@typo3/backend/severity.js";import Utility from"@typo3/backend/utility.js";import RegularEvent from"@typo3/core/event/regular-event.js";import DomHelper from"@typo3/backend/utility/dom-helper.js";import{selector}from"@typo3/core/literals.js";import SubmitInterceptor from"@typo3/backend/form/submit-interceptor.js";import{FormEngineReview}from"@typo3/backend/form-engine-review.js";let formEngineFormElement,validationSuspended=!1;const customEvaluations=new Map;class FormEngineValidation{static{this.rulesSelector="[data-formengine-validation-rules]"}static{this.inputSelector="[data-formengine-input-params]"}static{this.markerSelector=".t3js-formengine-validation-marker"}static{this.labelSelector=".t3js-formengine-label"}static{this.errorClass="has-error"}static{this.validationErrorClass="has-validation-error"}static{this.passwordDummy="********"}static initialize(t){formEngineFormElement=t,formEngineFormElement.querySelectorAll("."+FormEngineValidation.errorClass).forEach(e=>e.classList.remove(FormEngineValidation.errorClass)),FormEngineValidation.initializeInputFields(),new FormEngineReview(t),new RegularEvent("change",(e,a)=>{FormEngineValidation.validateField(a),FormEngineValidation.markFieldAsChanged(a)}).delegateTo(formEngineFormElement,FormEngineValidation.rulesSelector),FormEngineValidation.registerSubmitCallback(),FormEngineValidation.validate()}static initializeInputFields(){formEngineFormElement.querySelectorAll(FormEngineValidation.inputSelector).forEach(t=>{const a=JSON.parse(t.dataset.formengineInputParams).field,i=formEngineFormElement.querySelector(selector`[name="${a}"]`);"formengineInputInitialized"in t.dataset||(i.dataset.config=t.dataset.formengineInputParams,FormEngineValidation.initializeInputField(a))})}static initializeInputField(t){const e=formEngineFormElement.querySelector(selector`[name="${t}"]`),a=formEngineFormElement.querySelector(selector`[data-formengine-input-name="${t}"]`);if(e.dataset.config!==void 0){const i=JSON.parse(e.dataset.config),r=FormEngineValidation.formatByEvals(i,e.value);r.length&&(a.value=r)}new RegularEvent("change",()=>{FormEngineValidation.updateInputField(a.dataset.formengineInputName)}).bindTo(a),a.dataset.formengineInputInitialized="true"}static registerCustomEvaluation(t,e){customEvaluations.has(t)||customEvaluations.set(t,e)}static formatByEvals(t,e){if(t.evalList!==void 0){const a=Utility.trimExplode(",",t.evalList);for(const i of a)e=FormEngineValidation.formatValue(i,e)}return e}static formatValue(t,e){switch(t){case"date":case"datetime":case"time":case"timesec":if(e===""||e==="0")return"";const a=DateTime.fromISO(String(e),{zone:"utc"});if(!a.isValid)throw new Error("Invalid ISO8601 DateTime string: "+e);return a.toISO({suppressMilliseconds:!0});case"password":return e?FormEngineValidation.passwordDummy:"";default:return e.toString()}}static updateInputField(t){const e=formEngineFormElement.querySelector(selector`[name="${t}"]`),a=formEngineFormElement.querySelector(selector`[data-formengine-input-name="${t}"]`);if(e.dataset.config!==void 0){const i=JSON.parse(e.dataset.config),r=FormEngineValidation.processByEvals(i,a.value),l=FormEngineValidation.formatByEvals(i,r);e.value!==r&&(e.disabled&&e.dataset.enableOnModification&&(e.disabled=!1),e.value=r,e.dispatchEvent(new Event("change"))),a.value!==l&&(a.value=l)}}static validateField(t){if(t.dataset.formengineValidationRules===void 0)return;let e=t.value||"";const a=JSON.parse(t.dataset.formengineValidationRules);let i=!1,r=0,l,s,o;Array.isArray(e)||(e=e.trimStart());for(const n of a){if(i)break;switch(n.type){case"required":e===""&&(i=!0,t.classList.add(FormEngineValidation.errorClass),t.closest(FormEngineValidation.markerSelector)?.querySelector(FormEngineValidation.labelSelector)?.classList.add(FormEngineValidation.errorClass));break;case"range":if(e!==""){if((n.minItems||n.maxItems)&&(l=formEngineFormElement.querySelector(selector`[name="${t.dataset.relatedfieldname}"]`),l!==null?r=Utility.trimExplode(",",l.value).length:r=parseInt(t.value,10),n.minItems!==void 0&&(s=n.minItems*1,!isNaN(s)&&r<s&&(i=!0)),n.maxItems!==void 0&&(o=n.maxItems*1,!isNaN(o)&&r>o&&(i=!0))),n.lower!==void 0)if(t.dataset.inputType==="datetimepicker"){const m=DateTime.fromISO(e,{zone:"utc"}),d=DateTime.fromISO(n.lower,{zone:"utc"});(!m.isValid||m<d.minus(d.second*1e3))&&(i=!0)}else{const m=n.lower*1;!isNaN(m)&&parseInt(e,10)<m&&(i=!0)}if(n.upper!==void 0)if(t.dataset.inputType==="datetimepicker"){const m=DateTime.fromISO(e,{zone:"utc"}),d=DateTime.fromISO(n.upper,{zone:"utc"});(!m.isValid||m>d.plus((59-d.second)*1e3))&&(i=!0)}else{const m=n.upper*1;!isNaN(m)&&parseInt(e,10)>m&&(i=!0)}}break;case"select":case"category":(n.minItems||n.maxItems)&&(l=formEngineFormElement.querySelector(selector`[name="${t.dataset.relatedfieldname}"]`),l!==null?r=Utility.trimExplode(",",l.value).length:t instanceof HTMLSelectElement?r=t.querySelectorAll("option:checked").length:r=t.querySelectorAll("input[value]:checked").length,n.minItems!==void 0&&(s=n.minItems*1,!isNaN(s)&&r<s&&(i=!0)),n.maxItems!==void 0&&(o=n.maxItems*1,!isNaN(o)&&r>o&&(i=!0)));break;case"group":case"folder":(n.minItems||n.maxItems)&&(r=Utility.trimExplode(",",t.value).length,n.minItems!==void 0&&(s=n.minItems*1,!isNaN(s)&&r<s&&(i=!0)),n.maxItems!==void 0&&(o=n.maxItems*1,!isNaN(o)&&r>o&&(i=!0)));break;case"inline":(n.minItems||n.maxItems)&&(r=Utility.trimExplode(",",t.value).length,n.minItems!==void 0&&(s=n.minItems*1,!isNaN(s)&&r<s&&(i=!0)),n.maxItems!==void 0&&(o=n.maxItems*1,!isNaN(o)&&r>o&&(i=!0)));break;case"min":(t instanceof HTMLInputElement||t instanceof HTMLTextAreaElement)&&t.value.length>0&&t.value.length<t.minLength&&(i=!0);break;case"null":break;default:break}}const c=!i;t.classList.toggle(FormEngineValidation.errorClass,!c),t.closest(FormEngineValidation.markerSelector)?.querySelector(FormEngineValidation.labelSelector)?.classList.toggle(FormEngineValidation.errorClass,!c),FormEngineValidation.markParentTab(t,c),formEngineFormElement.dispatchEvent(new CustomEvent("t3-formengine-postfieldvalidation",{detail:{field:t,isValid:c},cancelable:!1,bubbles:!0}))}static processByEvals(t,e){if(t.evalList!==void 0){const a=Utility.trimExplode(",",t.evalList);for(const i of a)e=FormEngineValidation.processValue(i,e,t)}return e}static processValue(t,e,a){let i="",r="",l=0,s=e;switch(t){case"alpha":case"num":case"alphanum":case"alphanum_x":for(i="",l=0;l<e.length;l++){const o=e.substr(l,1);let c=o==="_"||o==="-",n=o>="a"&&o<="z"||o>="A"&&o<="Z",m=o>="0"&&o<="9";switch(t){case"alphanum":c=!1;break;case"alpha":m=!1,c=!1;break;case"num":n=!1,c=!1;break;default:break}(n||m||c)&&(i+=o)}i!==e&&(s=i);break;case"is_in":if(a.is_in){r=""+e,a.is_in=a.is_in.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&");const o=new RegExp("[^"+a.is_in+"]+","g");i=r.replace(o,"")}else i=r;s=i;break;case"nospace":s=(""+e).replace(/ /g,"");break;case"md5":e!==""&&(s=Md5.hash(e));break;case"upper":s=e.toUpperCase();break;case"lower":s=e.toLowerCase();break;case"integer":e!==""&&(s=FormEngineValidation.parseInt(e).toString());break;case"decimal":e!==""&&(s=FormEngineValidation.parseDouble(e));break;case"trim":s=String(e).trim();break;case"time":case"timesec":e!==""&&(s=DateTime.fromISO(e,{zone:"utc"}).set({year:1970,month:1,day:1}).toISO({suppressMilliseconds:!0}));break;case"year":if(e!==""){let o=parseInt(e,10);isNaN(o)&&(o=new Date().getUTCFullYear()),s=o.toString(10)}break;case"null":break;case"password":break;default:customEvaluations.has(t)?s=customEvaluations.get(t).call(null,e):typeof TBE_EDITOR=="object"&&TBE_EDITOR.customEvalFunctions!==void 0&&typeof TBE_EDITOR.customEvalFunctions[t]=="function"&&(s=TBE_EDITOR.customEvalFunctions[t](e))}return s}static validate(t){(typeof t>"u"||t instanceof Document)&&formEngineFormElement.querySelectorAll(FormEngineValidation.markerSelector+", .t3js-tabmenu-item").forEach(a=>{a.classList.remove(FormEngineValidation.validationErrorClass)});const e=t||document;for(const a of e.querySelectorAll(FormEngineValidation.rulesSelector))a.closest(".t3js-flex-section-deleted, .t3js-inline-record-deleted, .t3js-file-reference-deleted")===null&&FormEngineValidation.validateField(a)}static markFieldAsChanged(t){t.classList.add("has-change");const e=t.closest(".t3js-formengine-palette-field")?.querySelector(".t3js-formengine-label");e!==null&&e.classList.add("has-change")}static parseInt(t){const e=""+t;if(!t)return 0;const a=parseInt(e,10);return isNaN(a)?0:a}static parseDouble(t,e=2){let a=""+t;a=a.replace(/[^0-9,.-]/g,"");const i=a.startsWith("-");a=a.replace(/-/g,""),a=a.replace(/,/g,"."),a.indexOf(".")===-1&&(a+=".0");const r=a.split("."),l=r.pop();let s=+(r.join("")+"."+l);return i&&(s*=-1),a=s.toFixed(e),a}static pol(foreign,value){return eval((foreign=="-"?"-":"")+value)}static markParentTab(t,e){DomHelper.parents(t,".tab-pane").forEach(i=>{e&&(e=i.querySelector(".has-error")===null);const r=i.id;formEngineFormElement.querySelector('[data-bs-target="#'+r+'"]').closest(".t3js-tabmenu-item").classList.toggle(FormEngineValidation.validationErrorClass,!e)})}static suspend(){validationSuspended=!0}static resume(){validationSuspended=!1}static registerSubmitCallback(){new SubmitInterceptor(formEngineFormElement).addPreSubmitCallback(()=>{if(validationSuspended||document.querySelector("."+FormEngineValidation.errorClass)===null)return!0;const e=Modal.confirm(TYPO3.lang.alert||"Alert",TYPO3.lang["FormEngine.fieldsMissing"],Severity.error,[{text:TYPO3.lang["button.ok"]||"OK",active:!0,btnClass:"btn-default",name:"ok"}]);return e.addEventListener("button.clicked",()=>e.hideModal()),!1})}}export{FormEngineValidation as default};
