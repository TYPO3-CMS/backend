/*
 * This file is part of the TYPO3 CMS project.
 *
 * It is free software; you can redistribute it and/or modify it under
 * the terms of the GNU General Public License, either version 2
 * of the License, or any later version.
 *
 * For the full copyright and license information, please read the
 * LICENSE.txt file that was distributed with this source code.
 *
 * The TYPO3 project - inspiring people to share!
 */
import{SeverityEnum as f}from"@typo3/backend/enum/severity.js";import c from"jquery";import{Carousel as g}from"bootstrap";import u,{Identifiers as h}from"@typo3/backend/modal.js";import a from"@typo3/backend/severity.js";import m from"@typo3/backend/icons.js";import{topLevelModuleImport as S}from"@typo3/backend/utility/top-level-module-import.js";import d from"~labels/core.wizard";class v{constructor(){this.setup={slides:[],settings:{},forceSelection:!0,$carousel:null,carousel:null},this.originalSetup=c.extend(!0,{},this.setup)}set(e,t){return this.setup.settings[e]=t,this}addSlide(e,t,s="",i=f.info,n,r){const o={identifier:e,title:t,content:s,severity:i,progressBarTitle:n,callback:r};return this.setup.slides.push(o),this}async addFinalProcessingSlide(e){e||(e=()=>{this.dismiss()});const t=await m.getIcon("spinner-circle",m.sizes.large,null,null),s=document.createElement("div");s.classList.add("text-center"),s.append(document.createRange().createContextualFragment(t)),this.addSlide("final-processing-slide",d.get("wizard.processing.title"),s,a.notice,d.get("wizard.progressStep.finish"),e)}show(){const e=this.generateSlides(),t=this.setup.slides[0];u.advanced({title:t.title,content:e,severity:t.severity,staticBackdrop:!0,buttons:[{text:d.get("wizard.button.cancel"),active:!0,btnClass:"btn-default",name:"cancel",trigger:()=>{this.getComponent().trigger("wizard-dismiss")}},{text:d.get("wizard.button.prev"),btnClass:"btn-"+a.getCssClass(t.severity),name:"prev"},{text:d.get("wizard.button.next"),btnClass:"btn-"+a.getCssClass(t.severity),name:"next"}],additionalCssClasses:["modal-multi-step-wizard"],callback:s=>{S("@typo3/backend/element/progress-tracker-element.js").then(()=>{this.setup.carousel=new g(s.querySelector(".carousel")),this.addProgressBar(),this.initializeEvents(),this.setup.forceSelection&&(this.lockPrevStep(),this.lockNextStep());const i=this.setup.$carousel.find(".carousel-item").first();i.length>0&&t.callback&&this.runSlideCallback(t,i)})}}),this.getComponent().on("wizard-dismissed",()=>{this.setup=c.extend(!0,{},this.originalSetup)})}getComponent(){return this.setup.$carousel===null&&this.generateSlides(),this.setup.$carousel}dismiss(){u.dismiss()}lockNextStep(){const e=this.setup.$carousel.closest(".modal").find('button[name="next"]');return e.prop("disabled",!0),e}next(){this.setup.carousel.next()}previous(){this.setup.carousel.prev()}unlockNextStep(){const e=this.setup.$carousel.closest(".modal").find('button[name="next"]');return e.prop("disabled",!1),e}lockPrevStep(){const e=this.setup.$carousel.closest(".modal").find('button[name="prev"]');return e.prop("disabled",!0),e}unlockPrevStep(){const e=this.setup.$carousel.closest(".modal").find('button[name="prev"]');return e.prop("disabled",!1),e}triggerStepButton(e){const t=this.setup.$carousel.closest(".modal").find('button[name="'+e+'"]');return t.length>0&&t.prop("disabled")!==!0&&t.get(0).click(),t}blurCancelStep(){const e=this.setup.$carousel.closest(".modal").find('button[name="cancel"]');return e.trigger("blur"),e}initializeEvents(){const e=this.setup.$carousel.closest(".modal");this.initializeSlideNextEvent(e),this.initializeSlidePrevEvent(e),this.setup.$carousel.get(0).addEventListener("slide.bs.carousel",s=>{s.direction==="left"?this.nextSlideChanges(e):this.prevSlideChanges(e)}),this.setup.$carousel.get(0).addEventListener("slid.bs.carousel",s=>{const i=this.setup.$carousel.data("currentIndex"),n=this.setup.slides[i];this.setup.forceSelection&&this.lockNextStep();const r=c(s.relatedTarget);this.runSlideCallback(n,r)});const t=this.getComponent();t.on("wizard-dismiss",this.dismiss),u.currentModal.addEventListener("typo3-modal-hidden",()=>{t.trigger("wizard-dismissed")})}initializeSlideNextEvent(e){e.find(".modal-footer").find('button[name="next"]').off().on("click",()=>{this.setup.carousel.next()})}initializeSlidePrevEvent(e){e.find(".modal-footer").find('button[name="prev"]').off().on("click",()=>{this.setup.carousel.prev()})}nextSlideChanges(e){this.initializeSlideNextEvent(e);const t=this.setup.$carousel.data("currentSlide")+1,s=this.setup.$carousel.data("currentIndex"),i=s+1,n=this.setup.slides[i];u.currentModal.modalTitle=n.title,this.unlockPrevStep(),this.setup.$carousel.data("currentSlide",t),this.setup.$carousel.data("currentIndex",i),e.find("typo3-backend-progress-tracker").attr("active",i+1),this.updateCurrentSeverity(e,s,i)}prevSlideChanges(e){this.initializeSlidePrevEvent(e);const s=e.find(".modal-footer").find('button[name="next"]'),i=this.setup.$carousel.data("currentSlide")-1,n=this.setup.$carousel.data("currentIndex"),r=n-1,o=this.setup.slides[r];u.currentModal.modalTitle=o.title,r>0?this.unlockPrevStep():this.lockPrevStep(),this.setup.$carousel.data("currentSlide",i),this.setup.$carousel.data("currentIndex",r),s.text(d.get("wizard.button.next")),e.find("typo3-backend-progress-tracker").attr("active",r+1),this.updateCurrentSeverity(e,n,r)}updateCurrentSeverity(e,t,s){e.find(".modal-footer").find('button[name="next"]').removeClass("btn-"+a.getCssClass(this.setup.slides[t].severity)).addClass("btn-"+a.getCssClass(this.setup.slides[s].severity)),e.removeClass("modal-severity-"+a.getCssClass(this.setup.slides[t].severity)).addClass("modal-severity-"+a.getCssClass(this.setup.slides[s].severity))}runSlideCallback(e,t){typeof e.callback=="function"&&e.callback(t,this.setup.settings,e.identifier)}addProgressBar(){const e=this.setup.$carousel.find(".carousel-item").length,t=Math.max(1,e),s=Math.round(100/t);if(this.setup.$carousel.data("initialStep",s).data("slideCount",t).data("realSlideCount",e).data("currentIndex",0).data("currentSlide",1),t>1){const i=document.createElement("typo3-backend-progress-tracker");i.stages=this.setup.slides.map(p=>p.progressBarTitle);const n=this.setup.$carousel.get(0).closest(h.modal),r=n.querySelector(h.header),o=document.createElement("div");o.classList.add("modal-progress"),o.appendChild(i),r.nextSibling?n.insertBefore(o,r.nextSibling):n.appendChild(o)}}generateSlides(){if(this.setup.$carousel!==null)return this.setup.$carousel;const e=document.createElement("div");e.classList.add("carousel","slide"),e.dataset.bsRide="false";const t=document.createElement("div");t.classList.add("carousel-inner"),t.role="listbox",e.append(t);for(let s=0;s<this.setup.slides.length;++s){const i=this.setup.slides[s],n=document.createElement("div");if(n.classList.add("carousel-item"),n.dataset.bsSlide=i.identifier,n.dataset.step=s.toString(10),typeof i.content=="string")i.content!==""&&(n.textContent=i.content);else if(i.content instanceof c){const r=i.content.get(0);r&&n.append(r)}else if(i.content instanceof DocumentFragment)n.append(i.content);else{const r=i.content;n.append(r)}t.append(n)}return this.setup.$carousel=c(e),this.setup.$carousel.find(".carousel-item").first().addClass("active"),this.setup.$carousel}}let l;try{window.opener&&window.opener.TYPO3&&window.opener.TYPO3.MultiStepWizard&&(l=window.opener.TYPO3.MultiStepWizard),parent&&parent.window.TYPO3&&parent.window.TYPO3.MultiStepWizard&&(l=parent.window.TYPO3.MultiStepWizard),top&&top.TYPO3&&top.TYPO3.MultiStepWizard&&(l=top.TYPO3.MultiStepWizard)}catch{}l||(l=new v,typeof TYPO3<"u"&&(TYPO3.MultiStepWizard=l));var b=l;export{b as default};
