/*
 * This file is part of the TYPO3 CMS project.
 *
 * It is free software; you can redistribute it and/or modify it under
 * the terms of the GNU General Public License, either version 2
 * of the License, or any later version.
 *
 * For the full copyright and license information, please read the
 * LICENSE.txt file that was distributed with this source code.
 *
 * The TYPO3 project - inspiring people to share!
 */
import r from"@typo3/backend/icons.js";import p from"@typo3/backend/storage/persistent.js";import u from"@typo3/core/event/regular-event.js";import S from"@typo3/core/document-service.js";import{MultiRecordSelectionSelectors as w}from"@typo3/backend/multi-record-selection.js";import{selector as y}from"@typo3/core/literals.js";import E from"@typo3/backend/ajax-data-handler.js";class h{constructor(){this.identifier={entity:".t3js-entity",toggle:".t3js-toggle-recordlist",localize:".t3js-action-localize",hide:'button[data-datahandler-action="visibility"]',delete:".t3js-record-delete",editMultiple:".t3js-record-edit-multiple",icons:{collapse:"actions-view-list-collapse",expand:"actions-view-list-expand"}},this.toggleClick=(i,e)=>{i.preventDefault();const t=e.dataset.table,o=document.querySelector(e.dataset.bsTarget),l=o.dataset.state==="expanded",a=e.querySelector(".t3js-icon"),c=l?this.identifier.icons.expand:this.identifier.icons.collapse;r.getIcon(c,r.sizes.small).then(d=>{a.replaceWith(document.createRange().createContextualFragment(d))});let n={};p.isset("moduleData.web_list.collapsedTables")&&(n=p.get("moduleData.web_list.collapsedTables"));const s={};s[t]=l?1:0,n=Object.assign(n,s),p.set("moduleData.web_list.collapsedTables",n).then(()=>{o.dataset.state=l?"collapsed":"expanded"})},this.onEditMultiple=(i,e)=>{i.preventDefault();let t="",o="",l=[];const a=[];if(i.type==="multiRecordSelection:action:edit"){const n=i.detail,s=n.configuration;if(o=s.returnUrl||"",l=s.columnsOnly||[],t=s.tableName||"",t==="")return;n.checkboxes.forEach(d=>{const m=d.closest(w.elementSelector);m!==null&&m.dataset[s.idField]&&a.push(m.dataset[s.idField])})}else{const n=e.closest("[data-table]");if(n===null||(t=n.dataset.table||"",t===""))return;o=e.dataset.returnUrl||"",l=JSON.parse(e.dataset.columnsOnly||"{}");const s=n.querySelectorAll(this.identifier.entity+'[data-uid][data-table="'+t+'"] td.col-checkbox input[type="checkbox"]:checked');if(s.length)s.forEach(d=>{a.push(d.closest(this.identifier.entity+y`[data-uid][data-table="${t}"]`).dataset.uid)});else{const d=n.querySelectorAll(this.identifier.entity+y`[data-uid][data-table="${t}"]`);if(!d.length)return;d.forEach(m=>{a.push(m.dataset.uid)})}}if(!a.length)return;let c=top.TYPO3.settings.FormEngine.moduleUrl+"&edit["+t+"]["+a.join(",")+"]=edit&returnUrl="+h.getReturnUrl(o);l.length>0&&(c+=l.map((n,s)=>"&columnsOnly["+t+"]["+s+"]="+n).join("")),window.location.href=c},this.disableButton=(i,e)=>{e.setAttribute("disabled","disabled"),e.classList.add("disabled")},this.toggleVisibility=(i,e)=>{const t=e.closest("tr[data-uid]"),o=e.querySelector(".t3js-icon");r.getIcon("spinner-circle",r.sizes.small).then(n=>{o.replaceWith(document.createRange().createContextualFragment(n))});const l=e.dataset.datahandlerStatus==="visible",a={table:e.dataset.datahandlerTable,uid:e.dataset.datahandlerUid,field:e.dataset.datahandlerField,visible:l,overlayIcon:l?e.dataset.datahandlerRecordHiddenOverlayIcon??"overlay-hidden":e.dataset.datahandlerRecordVisibleOverlayIcon??null},c={data:{[a.table]:{[a.uid]:{[a.field]:a.visible?e.dataset.datahandlerHiddenValue:e.dataset.datahandlerVisibleValue}}}};E.process(c).then(n=>{if(!n.hasErrors){a.visible=!a.visible,e.setAttribute("data-datahandler-status",a.visible?"visible":"hidden");const s=a.visible?e.dataset.datahandlerVisibleLabel:e.dataset.datahandlerHiddenLabel;e.setAttribute("title",s);const d=a.visible?e.dataset.datahandlerVisibleIcon:e.dataset.datahandlerHiddenIcon,m=e.querySelector(".t3js-icon");r.getIcon(d,r.sizes.small).then(b=>{m.replaceWith(document.createRange().createContextualFragment(b))});const f=t.querySelector(".col-icon .t3js-icon");f.querySelector(".icon-overlay")?.remove(),r.getIcon("miscellaneous-placeholder",r.sizes.small,a.overlayIcon).then(b=>{const g=document.createRange().createContextualFragment(b);f.append(g.querySelector(".icon-overlay"))});const v=new u("animationend",()=>{t.classList.remove("record-pulse"),v.release()});v.bindTo(t),t.classList.add("record-pulse"),a.table==="pages"&&top.document.dispatchEvent(new CustomEvent("typo3:pagetree:refresh"))}})},this.registerPaginationEvents=()=>{document.querySelectorAll(".t3js-recordlist-paging").forEach(i=>{i.addEventListener("keyup",e=>{e.preventDefault();let t=Number(i.value);const o=Number(i.min),l=Number(i.max);if(o&&t<o&&(t=o),l&&t>l&&(t=l),i.value=t.toString(10),e.key==="Enter"&&t!==Number(i.dataset.currentpage)){const a=i.closest('form[name^="list-table-form-"]'),c=new URL(a.action,window.origin);c.searchParams.set("pointer",t.toString()),window.location.href=c.toString()}})})},new u("click",this.toggleClick).delegateTo(document,this.identifier.toggle),new u("click",this.onEditMultiple).delegateTo(document,this.identifier.editMultiple),new u("click",this.disableButton).delegateTo(document,this.identifier.localize),new u("click",this.toggleVisibility).delegateTo(document,this.identifier.hide),S.ready().then(()=>{this.registerPaginationEvents()}),new u("multiRecordSelection:action:edit",this.onEditMultiple).bindTo(document),new u("multiRecordSelection:action:copyMarked",i=>{h.submitClipboardFormWithCommand("copyMarked",i.target)}).bindTo(document),new u("multiRecordSelection:action:removeMarked",i=>{h.submitClipboardFormWithCommand("removeMarked",i.target)}).bindTo(document)}static submitClipboardFormWithCommand(i,e){const t=e.closest("form");if(!t)return;const o=t.querySelector('input[name="cmd"]');o&&(o.value=i,t.submit())}static getReturnUrl(i){return i===""&&(i=top.list_frame.document.location.pathname+top.list_frame.document.location.search),encodeURIComponent(i)}}var I=new h;export{I as default};
