/*
 * This file is part of the TYPO3 CMS project.
 *
 * It is free software; you can redistribute it and/or modify it under
 * the terms of the GNU General Public License, either version 2
 * of the License, or any later version.
 *
 * For the full copyright and license information, please read the
 * LICENSE.txt file that was distributed with this source code.
 *
 * The TYPO3 project - inspiring people to share!
 */
var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,s,i){void 0===i&&(i=s),Object.defineProperty(e,i,{enumerable:!0,get:function(){return t[s]}})}:function(e,t,s,i){void 0===i&&(i=s),e[i]=t[s]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&__createBinding(t,e,s);return __setModuleDefault(t,e),t};define(["require","exports","../Tree/DragDrop","d3-selection","../Modal","../Severity"],(function(e,t,s,i,r,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PageTreeNodeDragHandler=t.ToolbarDragHandler=t.PageTreeDragDrop=void 0,i=__importStar(i);class o extends s.DragDrop{changeNodePosition(e,t=""){const i=this.tree.nodes,r=this.tree.settings.nodeDrag.identifier;let n=this.tree.settings.nodeDragPosition,o=e||this.tree.settings.nodeDrag;if(r===o.identifier&&"delete"!==t)return null;if(n===s.DraggablePositionEnum.BEFORE){const t=i.indexOf(e),s=this.setNodePositionAndTarget(t);if(null===s)return null;n=s.position,o=s.target}return{node:this.tree.settings.nodeDrag,uid:r,target:o,position:n,command:t}}setNodePositionAndTarget(e){const t=this.tree.nodes,i=t[e].depth;e>0&&e--;const r=t[e].depth,n=this.tree.nodes[e];if(r===i)return{position:s.DraggablePositionEnum.AFTER,target:n};if(r<i)return{position:s.DraggablePositionEnum.INSIDE,target:n};for(let r=e;r>=0;r--){if(t[r].depth===i)return{position:s.DraggablePositionEnum.AFTER,target:this.tree.nodes[r]};if(t[r].depth<i)return{position:s.DraggablePositionEnum.AFTER,target:t[r]}}return null}}t.PageTreeDragDrop=o;t.ToolbarDragHandler=class{constructor(e,t,s){this.startDrag=!1,this.startPageX=0,this.startPageY=0,this.id="",this.name="",this.tooltip="",this.icon="",this.isDragged=!1,this.id=e.nodeType,this.name=e.title,this.tooltip=e.tooltip,this.icon=e.icon,this.tree=t,this.dragDrop=s}dragStart(e){return this.isDragged=!1,this.startDrag=!1,this.startPageX=e.sourceEvent.pageX,this.startPageY=e.sourceEvent.pageY,!0}dragDragged(e){return!!this.dragDrop.isDragNodeDistanceMore(e,this)&&(this.startDrag=!0,!1===this.isDragged&&(this.isDragged=!0,this.dragDrop.createDraggable("#icon-"+this.icon,this.name)),this.dragDrop.openNodeTimeout(),this.dragDrop.updateDraggablePosition(e),this.dragDrop.changeNodeClasses(e),!0)}dragEnd(e){return!!this.startDrag&&(this.isDragged=!1,this.dragDrop.removeNodeDdClass(),!(!0!==this.tree.settings.allowDragMove||!this.tree.hoveredNode||!this.tree.isOverSvg)&&(this.tree.settings.canNodeDrag&&this.addNewNode({type:this.id,name:this.name,tooltip:this.tooltip,icon:this.icon,position:this.tree.settings.nodeDragPosition,target:this.tree.hoveredNode}),!0))}addNewNode(e){const t=e.target;let r=this.tree.nodes.indexOf(t);const n={command:"new"};if(n.type=e.type,n.identifier="-1",n.target=t,n.parents=t.parents,n.parentsStateIdentifier=t.parentsStateIdentifier,n.depth=t.depth,n.position=e.position,n.name=void 0!==e.title?e.title:TYPO3.lang["tree.defaultPageTitle"],n.y=n.y||n.target.y,n.x=n.x||n.target.x,this.tree.nodeIsEdit=!0,e.position===s.DraggablePositionEnum.INSIDE&&(n.depth++,n.parents.unshift(r),n.parentsStateIdentifier.unshift(this.tree.nodes[r].stateIdentifier),this.tree.nodes[r].hasChildren=!0,this.tree.showChildren(this.tree.nodes[r])),e.position!==s.DraggablePositionEnum.INSIDE&&e.position!==s.DraggablePositionEnum.AFTER||r++,e.icon&&(n.icon=e.icon),n.position===s.DraggablePositionEnum.AFTER){const e=this.dragDrop.setNodePositionAndTarget(r);null!==e&&(n.position=e.position,n.target=e.target)}this.tree.nodes.splice(r,0,n),this.tree.setParametersNode(),this.tree.prepareDataForVisibleNodes(),this.tree.updateVisibleNodes(),this.tree.removeEditedText(),i.select(this.tree.svg.node().parentNode).append("input").attr("class","node-edit").style("top",n.y+this.tree.settings.marginTop+"px").style("left",n.x+this.tree.textPosition+5+"px").style("width",this.tree.settings.width-(n.x+this.tree.textPosition+20)+"px").style("height",this.tree.settings.nodeHeight+"px").attr("text","text").attr("value",n.name).on("keydown",e=>{const t=e.target,s=e.keyCode;if(13===s||9===s){this.tree.nodeIsEdit=!1;const e=t.value.trim();e.length?(n.name=e,this.tree.removeEditedText(),this.tree.sendChangeCommand(n)):this.removeNode(n)}else 27===s&&(this.tree.nodeIsEdit=!1,this.removeNode(n))}).on("blur",e=>{if(this.tree.nodeIsEdit&&this.tree.nodes.indexOf(n)>-1){const t=e.target.value.trim();t.length?(n.name=t,this.tree.removeEditedText(),this.tree.sendChangeCommand(n)):this.removeNode(n)}}).node().select()}removeNode(e){let t=this.tree.nodes.indexOf(e);this.tree.nodes[t-1].depth==e.depth||this.tree.nodes[t+1]&&this.tree.nodes[t+1].depth==e.depth||(this.tree.nodes[t-1].hasChildren=!1),this.tree.nodes.splice(t,1),this.tree.setParametersNode(),this.tree.prepareDataForVisibleNodes(),this.tree.updateVisibleNodes(),this.tree.removeEditedText()}};t.PageTreeNodeDragHandler=class{constructor(e,t){this.startDrag=!1,this.startPageX=0,this.startPageY=0,this.isDragged=!1,this.nodeIsOverDelete=!1,this.tree=e,this.dragDrop=t}dragStart(e){const t=e.subject;return!0===this.tree.settings.allowDragMove&&0!==t.depth&&(this.dropZoneDelete=null,t.allowDelete&&(this.dropZoneDelete=this.tree.nodesContainer.select('.node[data-state-id="'+t.stateIdentifier+'"]').append("g").attr("class","nodes-drop-zone").attr("height",this.tree.settings.nodeHeight),this.nodeIsOverDelete=!1,this.dropZoneDelete.append("rect").attr("height",this.tree.settings.nodeHeight).attr("width","50px").attr("x",0).attr("y",0).on("mouseover",()=>{this.nodeIsOverDelete=!0}).on("mouseout",()=>{this.nodeIsOverDelete=!1}),this.dropZoneDelete.append("text").text(TYPO3.lang.deleteItem).attr("dx",5).attr("dy",15),this.dropZoneDelete.node().dataset.open="false",this.dropZoneDelete.node().style.transform=this.getDropZoneCloseTransform(t)),this.startPageX=e.sourceEvent.pageX,this.startPageY=e.sourceEvent.pageY,this.startDrag=!1,!0)}dragDragged(e){const t=e.subject;if(!this.dragDrop.isDragNodeDistanceMore(e,this))return!1;if(this.startDrag=!0,!0!==this.tree.settings.allowDragMove||0===t.depth)return!1;this.tree.settings.nodeDrag=t;const s=this.tree.svg.node().querySelector('.node-bg[data-state-id="'+t.stateIdentifier+'"]'),i=this.tree.svg.node().parentNode.querySelector(".node-dd");return this.isDragged||(this.isDragged=!0,this.dragDrop.createDraggable(this.tree.getIconId(t),t.name),s.classList.add("node-bg--dragging")),this.tree.settings.nodeDragPosition=!1,this.dragDrop.openNodeTimeout(),this.dragDrop.updateDraggablePosition(e),t.isOver||this.tree.hoveredNode&&-1!==this.tree.hoveredNode.parentsStateIdentifier.indexOf(t.stateIdentifier)||!this.tree.isOverSvg?(this.dragDrop.addNodeDdClass(i,"nodrop"),this.tree.isOverSvg||this.tree.nodesBgContainer.selectAll(".node-bg__border").style("display","none"),this.dropZoneDelete&&"true"!==this.dropZoneDelete.node().dataset.open&&this.tree.isOverSvg&&this.animateDropZone("show",this.dropZoneDelete.node(),t)):this.tree.hoveredNode?this.dropZoneDelete&&"false"!==this.dropZoneDelete.node().dataset.open&&this.animateDropZone("hide",this.dropZoneDelete.node(),t):(this.dragDrop.addNodeDdClass(i,"nodrop"),this.tree.nodesBgContainer.selectAll(".node-bg__border").style("display","none")),this.dragDrop.changeNodeClasses(e),!0}dragEnd(e){const t=e.subject;if(this.dropZoneDelete&&"true"===this.dropZoneDelete.node().dataset.open){const e=this.dropZoneDelete;this.animateDropZone("hide",this.dropZoneDelete.node(),t,()=>{e.remove(),this.dropZoneDelete=null})}else this.dropZoneDelete=null;if(!this.startDrag||!0!==this.tree.settings.allowDragMove||0===t.depth)return!1;const i=this.tree.hoveredNode;if(this.isDragged=!1,this.dragDrop.removeNodeDdClass(),t.isOver||i&&-1!==i.parentsStateIdentifier.indexOf(t.stateIdentifier)||!this.tree.settings.canNodeDrag||!this.tree.isOverSvg){if(this.nodeIsOverDelete){const e=this.dragDrop.changeNodePosition(i,"delete");if(null===e)return!1;if(this.tree.settings.displayDeleteConfirmation){r.confirm(TYPO3.lang.deleteItem,TYPO3.lang["mess.delete"].replace("%s",e.node.name),n.warning,[{text:TYPO3.lang["labels.cancel"]||"Cancel",active:!0,btnClass:"btn-default",name:"cancel"},{text:TYPO3.lang["cm.delete"]||"Delete",btnClass:"btn-warning",name:"delete"}]).on("button.clicked",t=>{"delete"===t.target.name&&this.tree.sendChangeCommand(e),r.dismiss()})}else this.tree.sendChangeCommand(e)}}else{const e=this.dragDrop.changeNodePosition(i,"");if(null===e)return!1;let t=e.position===s.DraggablePositionEnum.INSIDE?TYPO3.lang["mess.move_into"]:TYPO3.lang["mess.move_after"];t=t.replace("%s",e.node.name).replace("%s",e.target.name),r.confirm(TYPO3.lang.move_page,t,n.warning,[{text:TYPO3.lang["labels.cancel"]||"Cancel",active:!0,btnClass:"btn-default",name:"cancel"},{text:TYPO3.lang["cm.copy"]||"Copy",btnClass:"btn-warning",name:"copy"},{text:TYPO3.lang["labels.move"]||"Move",btnClass:"btn-warning",name:"move"}]).on("button.clicked",t=>{const s=t.target;"move"===s.name?(e.command="move",this.tree.sendChangeCommand(e)):"copy"===s.name&&(e.command="copy",this.tree.sendChangeCommand(e)),r.dismiss()})}return!0}getDropZoneOpenTransform(e){return"translate("+((parseFloat(this.tree.svg.style("width"))||300)-58-e.x)+"px, -10px)"}getDropZoneCloseTransform(e){return"translate("+((parseFloat(this.tree.svg.style("width"))||300)-e.x)+"px, -10px)"}animateDropZone(e,t,s,i=null){t.classList.add("animating"),t.dataset.open="show"===e?"true":"false";let r=[{transform:this.getDropZoneCloseTransform(s)},{transform:this.getDropZoneOpenTransform(s)}];"show"!==e&&(r=r.reverse());const n=function(){t.style.transform=r[1].transform,t.classList.remove("animating"),i&&i()};"animate"in t?t.animate(r,{duration:300,easing:"cubic-bezier(.02, .01, .47, 1)"}).onfinish=n:n()}}}));