/*
 * This file is part of the TYPO3 CMS project.
 *
 * It is free software; you can redistribute it and/or modify it under
 * the terms of the GNU General Public License, either version 2
 * of the License, or any later version.
 *
 * For the full copyright and license information, please read the
 * LICENSE.txt file that was distributed with this source code.
 *
 * The TYPO3 project - inspiring people to share!
 */
import Icons from"@typo3/backend/icons.js";import PersistentStorage from"@typo3/backend/storage/persistent.js";import RegularEvent from"@typo3/core/event/regular-event.js";import DocumentService from"@typo3/core/document-service.js";import{MultiRecordSelectionSelectors}from"@typo3/backend/multi-record-selection.js";import{selector}from"@typo3/core/literals.js";import AjaxDataHandler from"@typo3/backend/ajax-data-handler.js";import Modal from"@typo3/backend/modal.js";import{SeverityEnum}from"@typo3/backend/enum/severity.js";import AjaxRequest from"@typo3/core/ajax/ajax-request.js";class Recordlist{constructor(){this.identifier={entity:".t3js-entity",toggle:".t3js-toggle-recordlist",localize:".t3js-action-localize",hide:'button[data-datahandler-action="visibility"]',delete:".t3js-record-delete",editMultiple:".t3js-record-edit-multiple",icons:{collapse:"actions-view-list-collapse",expand:"actions-view-list-expand"}},this.toggleClick=(e,t)=>{e.preventDefault();const a=t.dataset.table,n=document.querySelector(t.dataset.bsTarget),l="expanded"===n.dataset.state,o=t.querySelector(".t3js-icon"),s=l?this.identifier.icons.expand:this.identifier.icons.collapse;Icons.getIcon(s,Icons.sizes.small).then((e=>{o.replaceWith(document.createRange().createContextualFragment(e))}));let i={};PersistentStorage.isset("moduleData.web_list.collapsedTables")&&(i=PersistentStorage.get("moduleData.web_list.collapsedTables"));const r={};r[a]=l?1:0,i=Object.assign(i,r),PersistentStorage.set("moduleData.web_list.collapsedTables",i).then((()=>{n.dataset.state=l?"collapsed":"expanded"}))},this.onEditMultiple=(e,t)=>{e.preventDefault();let a="",n="",l=[];const o=[];if("multiRecordSelection:action:edit"===e.type){const t=e.detail,s=t.configuration;if(n=s.returnUrl||"",l=s.columnsOnly||[],a=s.tableName||"",""===a)return;t.checkboxes.forEach((e=>{const t=e.closest(MultiRecordSelectionSelectors.elementSelector);null!==t&&t.dataset[s.idField]&&o.push(t.dataset[s.idField])}))}else{const e=t.closest("[data-table]");if(null===e)return;if(a=e.dataset.table||"",""===a)return;n=t.dataset.returnUrl||"",l=JSON.parse(t.dataset.columnsOnly||"{}");const s=e.querySelectorAll(this.identifier.entity+'[data-uid][data-table="'+a+'"] td.col-checkbox input[type="checkbox"]:checked');if(s.length)s.forEach((e=>{o.push(e.closest(this.identifier.entity+selector`[data-uid][data-table="${a}"]`).dataset.uid)}));else{const t=e.querySelectorAll(this.identifier.entity+selector`[data-uid][data-table="${a}"]`);if(!t.length)return;t.forEach((e=>{o.push(e.dataset.uid)}))}}if(!o.length)return;let s=top.TYPO3.settings.FormEngine.moduleUrl+"&edit["+a+"]["+o.join(",")+"]=edit&returnUrl="+Recordlist.getReturnUrl(n);l.length>0&&(s+=l.map(((e,t)=>"&columnsOnly["+a+"]["+t+"]="+e)).join("")),window.location.href=s},this.disableButton=(e,t)=>{t.setAttribute("disabled","disabled"),t.classList.add("disabled")},this.toggleVisibility=(e,t)=>{const a=t.closest("tr[data-uid]"),n=t.querySelector(".t3js-icon");Icons.getIcon("spinner-circle",Icons.sizes.small).then((e=>{n.replaceWith(document.createRange().createContextualFragment(e))}));const l="visible"===t.dataset.datahandlerStatus,o={table:t.dataset.datahandlerTable,uid:t.dataset.datahandlerUid,field:t.dataset.datahandlerField,visible:l,overlayIcon:l?t.dataset.datahandlerRecordHiddenOverlayIcon??"overlay-hidden":t.dataset.datahandlerRecordVisibleOverlayIcon??null},s={data:{[o.table]:{[o.uid]:{[o.field]:o.visible?t.dataset.datahandlerHiddenValue:t.dataset.datahandlerVisibleValue}}}};AjaxDataHandler.process(s).then((e=>{if(!e.hasErrors){o.visible=!o.visible,t.setAttribute("data-datahandler-status",o.visible?"visible":"hidden");const e=o.visible?t.dataset.datahandlerVisibleLabel:t.dataset.datahandlerHiddenLabel;t.setAttribute("title",e);const n=o.visible?t.dataset.datahandlerVisibleIcon:t.dataset.datahandlerHiddenIcon,l=t.querySelector(".t3js-icon");Icons.getIcon(n,Icons.sizes.small).then((e=>{l.replaceWith(document.createRange().createContextualFragment(e))}));const s=a.querySelector(".col-icon .t3js-icon");s.querySelector(".icon-overlay")?.remove(),Icons.getIcon("miscellaneous-placeholder",Icons.sizes.small,o.overlayIcon).then((e=>{const t=document.createRange().createContextualFragment(e);s.append(t.querySelector(".icon-overlay"))}));const i=new RegularEvent("animationend",(()=>{a.classList.remove("record-pulse"),i.release()}));i.bindTo(a),a.classList.add("record-pulse"),"pages"===o.table&&top.document.dispatchEvent(new CustomEvent("typo3:pagetree:refresh"))}}))},this.deleteRecord=(e,t)=>{e.preventDefault();const a=Modal.confirm(t.dataset.title,t.dataset.message,SeverityEnum.warning,[{text:t.dataset.buttonCloseText||TYPO3.lang["button.cancel"]||"Cancel",active:!0,btnClass:"btn-default",name:"cancel"},{text:t.dataset.buttonOkText||TYPO3.lang["button.delete"]||"Delete",btnClass:"btn-warning",name:"delete"}]);a.addEventListener("button.clicked",(e=>{if("cancel"===e.target.getAttribute("name"))a.hideModal();else if("delete"===e.target.getAttribute("name")){a.hideModal(),t.disabled=!0;const e=t.querySelector(".t3js-icon");Icons.getIcon("spinner-circle",Icons.sizes.small).then((t=>{e.replaceWith(document.createRange().createContextualFragment(t))}));const n=t.closest("table[data-table]"),l="pages_translated"===n.dataset.table?"pages":n.dataset.table,o=t.closest("tr[data-uid]"),s=parseInt(o.dataset.uid,10),i={component:"datahandler",action:"delete",table:l,uid:s};AjaxDataHandler.process({cmd:{[l]:{[s]:{delete:!0}}}},i).then((e=>{e.hasErrors&&(t.disabled=!1,Icons.getIcon("actions-edit-delete",Icons.sizes.small).then((e=>{t.querySelector(".t3js-icon").replaceWith(document.createRange().createContextualFragment(e))})))})).catch((()=>{t.disabled=!1,Icons.getIcon("actions-edit-delete",Icons.sizes.small).then((e=>{t.querySelector(".t3js-icon").replaceWith(document.createRange().createContextualFragment(e))}))}))}}))},this.registerPaginationEvents=()=>{document.querySelectorAll(".t3js-recordlist-paging").forEach((e=>{e.addEventListener("keyup",(t=>{t.preventDefault();let a=Number(e.value);const n=Number(e.min),l=Number(e.max);if(n&&a<n&&(a=n),l&&a>l&&(a=l),e.value=a.toString(10),"Enter"===t.key&&a!==Number(e.dataset.currentpage)){const t=e.closest('form[name^="list-table-form-"]'),n=new URL(t.action,window.origin);n.searchParams.set("pointer",a.toString()),window.location.href=n.toString()}}))}))},new RegularEvent("click",this.toggleClick).delegateTo(document,this.identifier.toggle),new RegularEvent("click",this.onEditMultiple).delegateTo(document,this.identifier.editMultiple),new RegularEvent("click",this.disableButton).delegateTo(document,this.identifier.localize),new RegularEvent("click",this.toggleVisibility).delegateTo(document,this.identifier.hide),new RegularEvent("click",this.deleteRecord).delegateTo(document,this.identifier.delete),DocumentService.ready().then((()=>{this.registerPaginationEvents()})),new RegularEvent("typo3:datahandler:process",this.handleDataHandlerResult.bind(this)).bindTo(document),new RegularEvent("multiRecordSelection:action:edit",this.onEditMultiple).bindTo(document),new RegularEvent("multiRecordSelection:action:copyMarked",(e=>{Recordlist.submitClipboardFormWithCommand("copyMarked",e.target)})).bindTo(document),new RegularEvent("multiRecordSelection:action:removeMarked",(e=>{Recordlist.submitClipboardFormWithCommand("removeMarked",e.target)})).bindTo(document)}static submitClipboardFormWithCommand(e,t){const a=t.closest("form");if(!a)return;const n=a.querySelector('input[name="cmd"]');n&&(n.value=e,a.submit())}static getReturnUrl(e){return""===e&&(e=top.list_frame.document.location.pathname+top.list_frame.document.location.search),encodeURIComponent(e)}handleDataHandlerResult(e){const t=e.detail.payload;if(!t.hasErrors&&"delete"===t.action){const e=Array.from(document.querySelectorAll("table[data-table]")).map((e=>e.dataset.table));this.reloadTables(e)}}reloadTables(e){for(const t of e){const e=document.querySelector(`table[data-table="${t}"]`);if(e instanceof HTMLTableElement){e.closest(".recordlist").classList.add("ui-block-overlay")}}const t=new URL(window.location.href),a={id:t.searchParams.get("id"),pointer:t.searchParams.get("pointer"),searchTerm:t.searchParams.get("searchTerm"),search_levels:t.searchParams.get("search_levels"),sortField:t.searchParams.get("sortField"),sortRev:t.searchParams.get("sortRev"),table:t.searchParams.get("table"),tables:e};new AjaxRequest(TYPO3.settings.ajaxUrls.record_list_table).withQueryArguments(Object.fromEntries(Object.entries(a).filter((([,e])=>null!==e)))).get().then((async e=>{const t=await e.resolve();for(const[e,a]of Object.entries(t.tables)){const t=document.querySelector(`table[data-table="${e}"]`);if(t instanceof HTMLTableElement){t.closest(".recordlist").replaceWith(document.createRange().createContextualFragment(a))}}"pages"in t.tables&&top.document.dispatchEvent(new CustomEvent("typo3:pagetree:refresh"))})).finally((()=>{for(const t of e){const e=document.querySelector(`table[data-table="${t}"]`);if(e instanceof HTMLTableElement){e.closest(".recordlist").classList.remove("ui-block-overlay")}}}))}}export default new Recordlist;